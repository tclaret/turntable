<!DOCTYPE html>
<html lang="fr">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Platine vinyle — Sélecteur Vintage</title>

<!-- FAVICON -->
<link rel="icon" type="image/x-icon" href="img/favicon.ico">


<style>
    /* * Cette section contient le CSS pour le style (équivalent de style.css) 
     * Y compris les ajustements pour le mode mobile.
     */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
        height:100vh;
        background:#222;
        display:flex;
        flex-direction: column;
        justify-content:center;
        align-items:center;
        font-family: "Helvetica Neue", Arial, sans-serif;
        color:white;
        user-select:none;
        overflow: hidden;
        padding: 20px; /* Ajout d'une marge pour éviter le clipping des contrôles zoomés */
    }

    #turntable-container {
        transition: transform 0.5s ease;
    }

    #turntable {
        position:relative;
        /* Taille augmentée */
        width:90vmin;
        height:90vmin;
        max-width:900px; 
        max-height:900px; 
        /* Couleur bois sombre */
        background: #634b32; 
        border-radius:12px;
        box-shadow:
            inset 0 0 0 10px rgba(0,0,0,0.2),
            0 20px 50px rgba(0,0,0,0.8);
        overflow:hidden;
    }

    /* Message d'erreur Audio */
    #audio-error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 15px;
        background: #cc0000;
        color: white;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
        z-index: 100;
        box-shadow: 0 0 20px rgba(0,0,0,0.8);
        display: none; /* Caché par défaut */
    }

    /* Panneau de contrôle général (Haut-Gauche) */
    .control-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 50;
        background: rgba(0, 0, 0, 0.4);
        padding: 10px;
        border-radius: 8px;
    }
    
    /* Boutons de style vintage */
    .vintage-btn {
        padding: 8px 16px;
        border: 1px solid #444;
        border-radius: 4px;
        background: linear-gradient(to bottom, #e0e0e0 0%, #b0b0b0 100%);
        color: #333;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        box-shadow: 
            0 3px 5px rgba(0,0,0,0.5),
            inset 0 1px 0 rgba(255,255,255,0.8);
        transition: transform 0.1s, box-shadow 0.1s, background 0.2s;
        text-shadow: 0 1px 0 rgba(255,255,255,0.5);
    }

    .vintage-btn:active {
        transform: translateY(2px);
        box-shadow: 
            0 1px 2px rgba(0,0,0,0.5),
            inset 0 2px 5px rgba(0,0,0,0.2);
        background: linear-gradient(to bottom, #b0b0b0 0%, #999 100%);
    }
    
    /* État actif spécifique du bouton zoom et direction */
    .vintage-btn.active-state {
        background: linear-gradient(to bottom, #aaddff 0%, #6699cc 100%);
        box-shadow: inset 0 0 10px #3498db;
    }


    /* --- Contrôle de la vitesse (Pitch) (Bas-Droit) --- */
    #pitch-control {
        position: absolute; 
        bottom: 20px;       
        right: 20px;        
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.4); 
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 50;
        width: 120px; 
    }

    #pitch-control label {
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        color: #ddd;
    }
    
    #pitch-slider {
        -webkit-appearance: none;
        width: 100px; 
        height: 8px;
        background: #333;
        outline: none;
        opacity: 0.9;
        -webkit-transition: .2s;
        transition: opacity .2s;
        border-radius: 4px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.8);
    }

    #pitch-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #f0f0f0;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0,0,0,0.5), inset 0 1px 0 #fff;
    }

    /* --- Échelle de Pitch --- */
    #pitch-scale {
        position: relative;
        width: 100px; 
        height: 10px;
        margin-top: 2px;
        margin-bottom: 5px;
    }

    .pitch-mark {
        position: absolute;
        bottom: 0;
        transform: translateX(-50%);
        height: 5px;
        width: 1px;
        background: #ccc;
    }

    .pitch-label {
        position: absolute;
        bottom: 5px;
        transform: translateX(-50%);
        font-size: 8px;
        color: #ccc;
        font-weight: normal;
        white-space: nowrap;
    }

    /* Marque longue pour le point zéro */
    .pitch-mark.zero {
        height: 8px;
        background: #00ff00; 
    }


    /* --- Disque vinyle (Réglages par défaut : Centré) --- */
    #vinyl {
        position:absolute;
        top:50%; 
        left:50%; /* Centré par défaut */
        transform: translate(-50%, -50%);
        width:85%; 
        height:85%;
        border-radius:50%;
        
        background-image: url('https://tclaret.github.io/turntable/img/DISC.png');
        background-size: cover;
        background-position: center;

        cursor:grab;
        will-change:transform;
        box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        transition: width 0.3s, height 0.3s, left 0.3s; /* Transition pour le zoom */
    }
    #vinyl:active { cursor:grabbing; }

    /* CLASSE POUR LE DÉCALAGE (Zoom 2 / mode Scratch - principalement pour Desktop) */
    .vinyl-scratch-mode {
        /* Rend le vinyle 1.25x plus grand que le plateau (pour le débordement) */
        width: 125% !important; 
        height: 125% !important; 
        /* Décale le centre vers la droite pour que le bord GAUCHE s'aligne avec le plateau (62.5% du plateau) */
        left: 62.5% !important; 
    }


    /* Conteneur RPM (Bas-Gauche) */
    #rpm-wrapper {
        position:absolute;
        /* Position non-mobile (Desktop) */
        bottom: 5%;
        /* Ajusté de 5% à 15% pour le rapprocher du centre */
        left: 15%; 
        width: auto;
        display: flex;
        flex-direction: column; 
        align-items: center;     
        gap: 8px;                
        z-index:45;
        background: rgba(0,0,0,0.2); 
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
        transition: all 0.3s ease-in-out; /* Pour l'effet d'agrandissement */
    }
    
    /* NOUVELLE CLASSE : Agrandissement en mode Scratch */
    #rpm-wrapper.rpm-enlarged {
        padding: 15px; 
    }
    
    #rpm-wrapper.rpm-enlarged .rpm-labels {
        width: 120px; 
        font-size: 12px; 
    }

    #rpm-wrapper.rpm-enlarged #rpm-controls {
        width: 120px; 
    }

    #rpm-wrapper.rpm-enlarged .rpm-choice {
        width: 20px; 
        height: 20px;
    }

    #rpm-wrapper.rpm-enlarged #rpm-img {
        width: 40px; 
    }


    /* 1. Étiquettes du haut (45 - OFF - 33) */
    .rpm-labels {
        display:flex;
        justify-content:space-between;
        width: 90px; 
        font-size: 10px;
        font-family: sans-serif;
        font-weight: bold;
        color: #d0d0d0;
        text-shadow: 0 1px 2px black;
        pointer-events: none; 
    }
    
    .rpm-labels span {
        width: 25px;
        text-align: center;
    }

    /* 2. Contrôles de points au milieu */
    #rpm-controls {
        display:flex;
        justify-content:space-between;
        width: 90px; 
        position: relative;
    }

    .rpm-choice {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #444;
        border: 2px solid #222;
        cursor: pointer;
        box-shadow: inset 0 2px 3px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.2);
        transition: background 0.2s;
        margin: 0 auto; 
    }

    .rpm-choice:hover { background: #666; }
    
    /* Lumière LED/Point actif */
    .rpm-choice.active { 
        background: #00ff00; 
        box-shadow: 0 0 10px #00ff00, inset 0 2px 3px rgba(0,0,0,0.5);
        border-color: #003300;
    }

    /* 3. Image du bouton en bas */
    #rpm-img {
        width: 30px; 
        height: auto;
        display: block;
        transform-origin: center center;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.7));
    }


    /* ------------------------------------------- */
    /* AJUSTEMENTS POUR MOBILE (< 768px)  */
    /* ------------------------------------------- */
    @media (max-width: 768px) {
        body {
            /* Permet à la platine d'occuper plus de hauteur sur les téléphones */
            justify-content: flex-start; 
            padding-top: 5vh;
            padding: 10px; /* Moins de padding sur mobile */
        }

        #turntable {
            /* Occupe toute la largeur disponible, mais une taille maximale inférieure */
            width: 95vw;
            height: 95vw;
            max-width: 600px; 
            max-height: 600px;
            box-shadow:
                inset 0 0 0 5px rgba(0,0,0,0.2),
                0 10px 30px rgba(0,0,0,0.8);
        }

        /* DÉFAUT MOBILE: Vue Scratch (pour une meilleure zone de scratch) */
        #vinyl {
            width: 125%; 
            height: 125%; 
            left: 62.5%; 
        }
        
        /* NOUVELLE CLASSE POUR LA VUE CENTRÉE SUR MOBILE */
        #vinyl.mobile-centered-mode {
            width: 85% !important; /* Revenir à la taille Desktop par défaut */
            height: 85% !important; 
            left: 50% !important; /* Revenir au centre */
        }

        /* 2. Repositionnement des contrôles pour l'ergonomie mobile */
        
        .control-panel {
            /* Boutons Arrêt/Zoom/Sens au milieu-haut */
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            gap: 10px;
            padding: 8px 15px;
        }

        .vintage-btn {
            padding: 6px 12px;
            font-size: 10px;
        }

        /* --- AMÉLIORATION ERGONOMIQUE MOBILE: RPM --- */
        #rpm-wrapper {
            /* Déplace le RPM PLUS HAUT pour ne pas être collé au bord */
            bottom: 50px; 
            /* Ajusté de 10px à 20px pour le décoller légèrement du bord */
            left: 20px;
            padding: 8px;
        }
        
        /* NOUVEAU: Augmenter la zone de clic RPM */
        .rpm-choice {
            /* Taille du point visible */
            width: 20px; 
            height: 20px;
        }
        
        #rpm-controls {
            /* Agrandir l'espace entre les points */
            width: 120px; 
        }

        /* NOUVEAU: Créer une zone de clic invisible autour du point RPM */
        .rpm-labels span {
            /* Permet aux chiffres (45, ARRÊT, 33) de servir de zone de clic */
            pointer-events: auto; /* Réactiver les événements de clic sur le texte */
            cursor: pointer;
            padding: 5px 0; /* Augmenter la zone tactile verticale */
            width: 40px; /* Augmenter la zone tactile horizontale */
            text-align: center;
            font-size: 12px; /* Rendre le texte plus lisible */
        }
        
        #pitch-control {
            /* Déplace le Pitch PLUS HAUT pour ne pas être collé au bord */
            bottom: 50px; 
            right: 10px;
            width: 100px; 
            padding: 5px;
        }

        #pitch-slider, #pitch-scale {
            width: 80px; 
        }

        .pitch-label {
            font-size: 7px;
        }
    }
</style>
</head>
<body>

<div id="turntable-container">
    <div id="turntable">
        
        <!-- Message d'erreur Audio -->
        <div id="audio-error">ERREUR AUDIO : Fichier JB.mp3 introuvable.</div>

        <!-- Panneau de contrôle (Haut-Gauche) -->
        <div class="control-panel">
            <button id="stop-button" class="vintage-btn">Arrêt</button>
            <button id="zoom-button" class="vintage-btn">Vue Scratch</button>
            <button id="direction-button" class="vintage-btn">Sens: Normal</button>
        </div>
        
        <!-- Contrôle de la vitesse (Pitch) (Bas-Droit) -->
        <div id="pitch-control">
            <label for="pitch-slider">Pitch</label>
            <input type="range" min="-15" max="15" value="0" id="pitch-slider">
            <div id="pitch-scale">
                
                <!-- +15% -->
                <span class="pitch-mark" style="left:0%;"></span>
                <span class="pitch-label" style="left:0%;">+15%</span>

                <!-- +10% -->
                <span class="pitch-mark" style="left:16.67%;"></span>
                <span class="pitch-label" style="left:16.67%;">+10</span>

                <!-- 0% -->
                <span class="pitch-mark zero" style="left:50%;"></span>
                <span class="pitch-label" style="left:50%; top: 1px;">0</span>

                <!-- -10% -->
                <span class="pitch-mark" style="left:83.33%;"></span>
                <span class="pitch-label" style="left:83.33%;">-10</span>

                <!-- -15% -->
                <span class="pitch-mark" style="left:100%;"></span>
                <span class="pitch-label" style="left:100%;">-15%</span>
            </div>
        </div>


        <!-- Le disque vinyle -->
        <div id="vinyl" style="transform: rotate(0deg);">
            <!-- Le disque est rendu par l'image de fond -->
        </div>

        <!-- Contrôle RPM (Bas-Gauche) -->
        <div id="rpm-wrapper">
            <!-- 1. Étiquettes du haut (45 - OFF - 33) -->
            <div class="rpm-labels">
                <span data-rpm="45">45</span>
                <span data-rpm="off">ARRÊT</span>
                <span data-rpm="33">33</span>
            </div>

            <!-- 2. Contrôles de points au milieu -->
            <div id="rpm-controls">
                <div class="rpm-choice" data-rpm="45" title="45 RPM"></div>
                <div class="rpm-choice active" data-rpm="off" title="Arrêt"></div>
                <!-- Clé '33' utilisée pour la vitesse 33 1/3 RPM -->
                <div class="rpm-choice" data-rpm="33" title="33 1/3 RPM"></div> 
            </div>

            <!-- 3. Image du bouton en bas -->
            <img id="rpm-img" 
                 src="https://tclaret.github.io/turntable/img/ChickenHead.png" 
                 alt="Bouton RPM"
                 style="transform: rotate(0deg);">
        </div>
    </div>
</div>

<script>
    /* * Cette section contient le JavaScript pour la logique (équivalent de script.js)
     * Logique mise à jour pour le contrôle DJ/Scratch
     */
    const vinyl = document.getElementById("vinyl");
    const rpmImg = document.getElementById("rpm-img");
    const rpmChoices = document.querySelectorAll('.rpm-choice');
    const rpmLabels = document.querySelectorAll('.rpm-labels span'); 
    const stopBtn = document.getElementById('stop-button');
    const zoomBtn = document.getElementById('zoom-button');
    const directionBtn = document.getElementById('direction-button');
    const turntableContainer = document.getElementById('turntable-container');
    const pitchSlider = document.getElementById('pitch-slider');
    const audioErrorDiv = document.getElementById('audio-error'); 
    const rpmWrapper = document.getElementById('rpm-wrapper'); 

    
    // VARIABLES D'ÉTAT
    let currentRotation = 0;
    let velocity = 0;
    let targetBaseVelocity = 0; 
    let currentPitchFactor = 1.0; 
    let isDragging = false;
    let lastAngle = 0;
    let center = {x:0, y:0};
    let rpmMode = "off";

    // Contrôle de la direction (1 pour Normal, -1 pour Inversé)
    let directionFactor = 1;

    // Constantes de physique
    const returnStrength = 0.08; 
    const dragSensitivity = 3.0; 
    const MAX_PLAYBACK_RATE = 2.5; 
    const MAX_SCRATCH_ACCELERATION = 0.5; 

    // État pour le mode Scratch/Décalé (par défaut sur mobile)
    let isScratchMode = (window.innerWidth <= 768);

    // État Audio
    let audioCuePointSeconds = 0; 
    let isPlaying = false; 
    let audioDurationSeconds = 0; 
    let currentBuffer = null; 
    
    // Calcul précis des degrés par frame (pour 60 FPS) :
    const RPM_BASE_SPEED = {"33": 3.3333, "45": 4.5, "off": 0}; 
    const NORMAL_RPM_VELOCITY = RPM_BASE_SPEED["33"]; // Vitesse en degrés par frame

    // Configuration Audio
    let audioCtx = null;
    let normalBuffer = null; 
    let reverseBuffer = null; 
    let source = null;
    // URL AUDIO
    const audioURL = "https://tclaret.github.io/turntable/JB.mp3"; 


    function initAudio(){ 
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); 
    }
    
    /**
     * Inverse les données d'un AudioBuffer et stocke le résultat.
     */
    function createReverseBuffer(originalBuffer) {
        if (!audioCtx) return null;

        const numChannels = originalBuffer.numberOfChannels;
        const length = originalBuffer.length;
        const reversed = audioCtx.createBuffer(numChannels, length, originalBuffer.sampleRate);

        for (let i = 0; i < numChannels; i++) {
            const originalData = originalBuffer.getChannelData(i);
            const reversedData = reversed.getChannelData(i);

            for (let j = 0; j < length; j++) {
                // Copie l'échantillon N à la position (Longueur - 1 - N)
                reversedData[j] = originalData[length - 1 - j];
            }
        }
        return reversed;
    }

    /**
     * Convertit la rotation visuelle (en degrés) en un décalage audio (en secondes).
     */
    function rotationToAudioOffset(degrees, duration) {
        // Normalise la rotation pour rester entre 0 et 360 (une révolution)
        const normalizedDegrees = degrees % 360;
        // Calcul du temps écoulé pour cette rotation
        let offset = (normalizedDegrees * duration / 360);
        
        // S'assurer que l'offset est positif
        if (offset < 0) {
            offset += duration;
        }
        return offset;
    }


    /*
     * Fonction ASYNC pour charger l'audio et démarrer la lecture.
     */
    async function startPlayback() {
        initAudio();
        if (audioCtx.state === 'suspended') {
            await audioCtx.resume();
        }

        // Chargement initial du buffer si nécessaire
        if(!normalBuffer) {
            try {
                const res = await fetch(audioURL); 
                if(!res.ok) throw new Error("Audio file not found: " + audioURL);
                const arr = await res.arrayBuffer(); 
                normalBuffer = await audioCtx.decodeAudioData(arr); 
                
                // CRÉATION DU BUFFER INVERSÉ
                reverseBuffer = createReverseBuffer(normalBuffer); 
                
                audioDurationSeconds = normalBuffer.duration; 
                audioErrorDiv.style.display = 'none'; 
            } catch(e) {
                console.error("Échec du chargement ou du décodage audio:", e);
                audioErrorDiv.innerHTML = `ERREUR AUDIO : Fichier <br> ${audioURL} <br> introuvable.`; 
                audioErrorDiv.style.display = 'block'; 
                return; 
            }
        }
        
        // Définir le buffer actuel en fonction du mode de direction
        currentBuffer = directionFactor === 1 ? normalBuffer : reverseBuffer;

        if(source) {
            try { source.stop(); } catch(e){}
        }

        // Taux de lecture initial pour l'AudioBuffer (toujours positif)
        const rpmSpeed = RPM_BASE_SPEED[rpmMode];
        let initialRate = (rpmSpeed / NORMAL_RPM_VELOCITY) * currentPitchFactor; 
        if (rpmMode === 'off' || NORMAL_RPM_VELOCITY === 0) initialRate = 1.0 * currentPitchFactor;
        
        initialRate = Math.abs(initialRate); 
        initialRate = Math.max(0.01, Math.min(MAX_PLAYBACK_RATE, initialRate)); 

        source = audioCtx.createBufferSource(); 
        source.buffer = currentBuffer; 
        source.loop = true; 
        
        source.playbackRate.value = initialRate; 
        source.connect(audioCtx.destination); 
        
        // Le point de départ doit être recalculé car le buffer inversé est utilisé
        let startOffset = audioCuePointSeconds;
        if (directionFactor === -1) {
            // Si en mode Inversé, on démarre du point dans le buffer inversé qui correspond au point de cue NORMAL
            startOffset = (audioDurationSeconds - audioCuePointSeconds) % audioDurationSeconds;
        }

        source.start(0, startOffset); 
        isPlaying = true;
    }

    /**
     * Arrête l'audio et sauvegarde le point de cue actuel.
     */
    function stopAudio() {
        if(source && audioCtx && normalBuffer) {
            try { 
                // Sauvegarder le point de cue par rapport au buffer NORMAL
                // On utilise la rotation actuelle et on la corrige par le facteur de direction
                // (la rotation négative en mode inversé correspond à un temps positif en mode normal)
                audioCuePointSeconds = rotationToAudioOffset(currentRotation * directionFactor, normalBuffer.duration);
                
                source.stop(); 
            } catch(e){
                console.error("Erreur lors de l'arrêt de la source audio:", e);
            }
        }
        source = null;
        isPlaying = false;
    }

    // --- Moteur Physique ---
    function updateCenter(){ 
        const r = vinyl.getBoundingClientRect(); 
        center.x = r.left + r.width/2; 
        center.y = r.top + r.height/2; 
    }
    updateCenter(); 
    window.addEventListener("resize", updateCenter);

    /**
     * Calcule l'angle du pointeur par rapport au centre de la platine.
     */
    function getAngle(e){ 
        return Math.atan2(e.clientY - center.y, e.clientX - center.x) * 180 / Math.PI; 
    }

    vinyl.addEventListener("pointerdown", async e => { 
        e.preventDefault(); 
        
        const angle = getAngle(e);
        // Zone de Scratch : Côté gauche du vinyle (sur l'écran)
        const isInScratchZone = (angle >= 90) || (angle <= -90);

        if (isInScratchZone) {
            if(!isPlaying && rpmMode !== 'off') {
                 // Démarrer l'audio si on est en mode RPM actif (pour que le son suive)
                 await startPlayback(); 
            }
            
            isDragging = true; 
            lastAngle = angle; 
            vinyl.setPointerCapture(e.pointerId); 
            vinyl.style.cursor = "grabbing";
        } else {
            isDragging = false; 
            vinyl.setPointerCapture(e.pointerId); 
            vinyl.style.cursor = "grab";
        }
    });

    vinyl.addEventListener("pointermove", e => { 
        if(!isDragging) return; 
        if(!isPlaying) return; 

        const ang = getAngle(e); 
        let delta = ang - lastAngle; 
        if(delta > 180) delta -= 360; 
        if(delta < -180) delta += 360; 
        lastAngle = ang; 
        
        const dragDelta = delta * dragSensitivity; 
        
        // Logique de vitesse DJ :
        const requestedChange = dragDelta - velocity;

        const limitedChange = Math.max(
            -MAX_SCRATCH_ACCELERATION, 
            Math.min(MAX_SCRATCH_ACCELERATION, requestedChange)
        );

        velocity += limitedChange; 
        currentRotation += velocity; 
        
    });

    vinyl.addEventListener("pointerup", () => { 
        isDragging = false; 
        
        // Recalculer la vitesse cible du moteur (+/- 33/45 RPM)
        updateTargetVelocity(); 
        
        if(rpmMode === 'off') {
            stopAudio(); 
            currentRotation = 0;
            velocity = 0; // Arrêt instantané
            vinyl.style.transform = `translate(-50%, -50%) rotate(0deg)`;
        } else {
            // FIX DJ : Dès que le doigt est levé, la vitesse (velocity) 
            // revient INSTANTANÉMENT à la vitesse du moteur (targetBaseVelocity).
            velocity = targetBaseVelocity; 
        }
        vinyl.style.cursor = "grab";
    });
    
    // --- Calcul de la vitesse cible ---
    function updateTargetVelocity() {
        // La vitesse cible du moteur tient compte du mode RPM et du sens de lecture
        targetBaseVelocity = RPM_BASE_SPEED[rpmMode] * currentPitchFactor * directionFactor;
    }

    function engine(){ 
        if(!isDragging){ 
            // Transition progressive (accélération/décélération) VERS la vitesse cible (uniquement si on ne scratch pas)
            velocity += (targetBaseVelocity - velocity) * returnStrength; 
        } 
        
        currentRotation += velocity; 
        
        const rotationTransform = `rotate(${currentRotation}deg)`;
        const baseTranslate = 'translate(-50%, -50%)';
        vinyl.style.transform = `${baseTranslate} ${rotationTransform}`;
        
        // Mise à jour de la vitesse de lecture audio (Pitch Shift)
        if(source && audioCtx && isPlaying){ 
            // Le taux de lecture est basé sur la valeur absolue de la vitesse actuelle (velocity)
            let targetRate = (Math.abs(velocity) / NORMAL_RPM_VELOCITY) * currentPitchFactor; 
            
            const finalRate = Math.max(0.01, Math.min(MAX_PLAYBACK_RATE, targetRate)); 
            
            source.playbackRate.value = finalRate; 
        } 
        
        requestAnimationFrame(engine); 
    }
    engine();

    // --- Logique de Contrôle RPM ---
    function setRPM(mode){
        rpmMode = mode;
        updateTargetVelocity(); 

        if (mode !== 'off') {
            const isStartingNew = !isPlaying;

            // Démarrage de la vitesse légèrement plus haute que la cible (spin up)
            velocity = targetBaseVelocity * 1.2; 
            
            if (isStartingNew) {
                startPlayback(); 
            } else {
                // Redémarrer l'audio pour s'assurer que le nouveau taux est pris en compte
                stopAudio();
                startPlayback();
            }

        } else {
            // Mode Arrêt
            velocity = 0; 
            stopAudio(); 
        }

        // Mettre à jour l'interface utilisateur (points et labels)
        rpmChoices.forEach(c => c.classList.remove('active'));
        document.querySelector(`.rpm-choice[data-rpm='${mode}']`).classList.add('active');
        
        // Rotation du bouton (45 - OFF - 33)
        if(mode === "45") rpmImg.style.transform = "rotate(-30deg)"; 
        else if(mode === "33") rpmImg.style.transform = "rotate(30deg)"; 
        else rpmImg.style.transform = "rotate(0deg)";
    }

    // --- Logique de Contrôle de la Direction (Sens) ---
    function toggleDirection() {
        // Inversion de la direction
        directionFactor *= -1; 

        // Mise à jour du bouton
        if (directionFactor === -1) {
            directionBtn.textContent = "Sens: Inversé";
            directionBtn.classList.add("active-state");
        } else {
            directionBtn.textContent = "Sens: Normal";
            directionBtn.classList.remove("active-state");
        }
        
        // Recalcul de la vitesse cible
        updateTargetVelocity();

        // Stoppe l'audio, sauvegarde le cue point NORMAL, et redémarre avec le nouveau buffer (Normal ou Inversé)
        if (isPlaying || rpmMode !== 'off') {
            stopAudio();
            startPlayback(); 
        } else {
             // Si à l'arrêt, on ne fait que mettre à jour la velocity (qui est 0) pour préparer le spin up
             velocity = targetBaseVelocity;
        }
    }


    // --- Écouteurs d'événements ---
    
    // Écouteurs pour les POINTS et LABELS RPM
    rpmChoices.forEach(c => c.addEventListener('click', () => { setRPM(c.dataset.rpm); }));
    rpmLabels.forEach(l => l.addEventListener('click', (e) => {
        const mode = e.target.dataset.rpm;
        if (mode) {
            setRPM(mode);
        }
    }));

    // Écouteur pour le nouveau bouton de direction
    directionBtn.addEventListener('click', toggleDirection);


    // --- Logique du Slider Pitch ---
    pitchSlider.addEventListener('input', () => {
        const percentageChange = parseFloat(pitchSlider.value) / 100; 
        currentPitchFactor = 1.0 + percentageChange;
        
        updateTargetVelocity(); 
        // Si en lecture, on applique la nouvelle vitesse immédiatement
        if (isPlaying || rpmMode !== 'off') {
            velocity = targetBaseVelocity;
        }
    });


    // --- Logique du Bouton Arrêt ---
    stopBtn.addEventListener('click', () => {
        setRPM("off"); 
    });

    // --- Logique du Bouton Vue Scratch (Zoom) ---
    function updateScratchModeUI() {
        const isMobile = window.innerWidth <= 768;

        if(isScratchMode) {
            // ACTIVER VUE SCRATCH
            vinyl.classList.add('vinyl-scratch-mode');
            vinyl.classList.remove('mobile-centered-mode'); // Assurer que le centré est retiré
            zoomBtn.classList.add("active-state");
            zoomBtn.textContent = "Vue Centrée";
            rpmWrapper.classList.add('rpm-enlarged'); 

            if (!isMobile) {
                // Zoom visuel pour le grand écran
                turntableContainer.style.transform = "scale(1.5)";
            } else {
                 // N'applique pas de zoom sur mobile pour garder les contrôles visibles
                 turntableContainer.style.transform = "scale(1)"; 
            }
        } else {
            // ACTIVER VUE CENTRÉE
            vinyl.classList.remove('vinyl-scratch-mode');
            zoomBtn.classList.remove("active-state");
            zoomBtn.textContent = "Vue Scratch";
            rpmWrapper.classList.remove('rpm-enlarged'); 
            
            if (isMobile) {
                // Application de la vue Centrée spécifique pour mobile pour annuler le défaut CSS
                vinyl.classList.add('mobile-centered-mode');
            } else {
                 vinyl.classList.remove('mobile-centered-mode');
            }

            // Retour au zoom standard (1.0x)
            turntableContainer.style.transform = "scale(1)";
        }
        setTimeout(updateCenter, 550); 
    }


    zoomBtn.addEventListener('click', () => {
        isScratchMode = !isScratchMode;
        // La fonction updateScratchModeUI gère maintenant la logique desktop/mobile
        updateScratchModeUI(); 
    });
    
    // Initialisation
    // Définir l'état initial du mode scratch (défaut: actif sur mobile, inactif sur desktop)
    isScratchMode = (window.innerWidth <= 768);
    setRPM("off");
    updateScratchModeUI();

</script>
</body>
</html>
