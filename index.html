<!DOCTYPE html>
<html lang="fr">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Scratching Vinyl</title>

<!-- Tailwind CSS et Tone.js pour l'audio avancé -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

<style>
    /* Configuration du fond et de la police */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #1a1a2e; /* Couleur de fond sombre pour l'ambiance */
        color: #ffffff;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden; 
    }
    
    /* Le conteneur principal de la platine */
    #turntable-container {
        position: relative;
        width: 90vmin;
        height: 90vmin;
        max-width: 900px;
        max-height: 900px;
        background: #333; /* Couleur de base pour le plateau */
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        overflow: hidden;
        /* Centre la platine dans le viewport */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    /* Styles pour le VINYLE (au centre de la platine) */
    #vinyl-image {
        /* Position absolue au centre du #turntable-container */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* Clé du centrage parfait */
        
        width: 80%;
        height: 80%;
        border-radius: 50%;
        
        /* Utilisation de l'image de vinyle fournie par l'utilisateur */
        background-image: url('https://tclaret.github.io/turntable/img/DISC.png');
        background-size: cover;
        background-position: center;
        
        border: 1px solid #111;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 10px rgba(0, 0, 0, 0.9);
        z-index: 10;
        cursor: grab;
        touch-action: none; 
        transition: none;
    }
    
    /* Le SVG à l'intérieur du vinyle pour l'étiquette centrale (invisible car l'image est utilisée) */
    #vinyl-image svg {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 25%; 
        height: 25%;
        opacity: 0; 
        pointer-events: none;
    }


    /* ---------------------------------------------------- */
    /* NOUVEAUX STYLES RPM - Structure en bas à gauche */
    /* ---------------------------------------------------- */
    #rpm-wrapper {
        position: absolute; bottom: 5%; left: 5%; width: auto;
        display: flex; flex-direction: column; align-items: center;     
        gap: 8px; z-index: 50; background: rgba(0,0,0,0.2); 
        padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
        transition: left 0.5s ease-in-out, padding 0.3s ease;
    }
    
    /* Classe pour centrer le RPM en mode Zoom sur desktop */
    .rpm-scratch-centered { left: 15% !important; }

    /* Étiquettes du haut (45 - OFF - 33) */
    .rpm-labels {
        display:flex; justify-content:space-between; width: 90px; font-size: 10px;
        font-family: sans-serif; font-weight: bold; color: #d0d0d0;
        text-shadow: 0 1px 2px black; pointer-events: none;
    }
    .rpm-labels span { width: 25px; text-align: center; }

    /* Contrôles de points au milieu */
    #rpm-controls { display:flex; justify-content:space-between; width: 90px; position: relative; }

    .rpm-choice {
        width: 16px; height: 16px; border-radius: 50%; background: #444; border: 2px solid #222;
        cursor: pointer; box-shadow: inset 0 2px 3px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.2);
        transition: background 0.2s; margin: 0 auto; 
    }
    .rpm-choice:hover { background: #666; }
    .rpm-choice.active { 
        background: #00ff00; 
        box-shadow: 0 0 10px #00ff00, inset 0 2px 3px rgba(0,0,0,0.5);
        border-color: #003300;
    }

    /* Image du bouton en bas */
    #rpm-img {
        width: 30px; height: auto; display: block;
        transform-origin: center center;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.7));
    }

    /* Pitch Control (Bas-Droite) */
    #pitch-wrapper {
        position: absolute; bottom: 5%; right: 5%; width: 120px;
        background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1); z-index: 50;
    }
    #pitch-slider {
        -webkit-appearance: none; width: 100%; height: 6px; background: #444;
        border-radius: 3px; outline: none; cursor: pointer;
    }
    #pitch-slider::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none; width: 16px; height: 16px;
        border-radius: 50%; background: #00bcd4; cursor: pointer;
        box-shadow: 0 0 5px rgba(0, 188, 212, 0.8);
    }
    
    /* Boutons de contrôle (Haut) */
    #top-controls {
        position: absolute; top: 2%; left: 50%; transform: translateX(-50%);
        display: flex; gap: 15px; z-index: 60; padding: 10px; border-radius: 12px;
    }
    .control-button {
        padding: 8px 15px; border-radius: 6px; font-size: 14px; font-weight: bold;
        cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .control-button:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.4); }

    /* Le rectangle d'affichage (en haut à droite) */
    #overlay-box {
        position: absolute; top: 5%; right: 5%; width: 150px; height: 60px;
        background-color: rgba(60, 60, 80, 0.7); border-radius: 8px;
        display: flex; flex-direction: column; justify-content: center;
        align-items: center; font-size: 14px; z-index: 20; 
        
        /* Transition pour l'opacité et positionnement initial */
        transition: opacity 0.5s ease-out;
    }

    /* État caché initial */
    .overlay-hidden { opacity: 0; pointer-events: none; }
    
    #overlay-box #status-message { font-size: 10px; color: #999; }

    /* ---------------------------------------------------- */
    /* Styles pour le mode Mobile / Vue Zoom */
    /* ---------------------------------------------------- */
    @media (max-width: 768px) {
        /* Vinyle décalé vers la droite, bord gauche libre pour le pouce (mode scratch par défaut) */
        #vinyl-image { left: 62.5%; width: 100%; height: 100%; }

        /* Centrage du vinyle en mode Vue Centrée sur mobile */
        #vinyl-image.centered-mobile { left: 50%; width: 80%; height: 80%; }

        /* RPM et Pitch légèrement plus petits et plus hauts */
        #rpm-wrapper { bottom: 20px; left: 10px; padding: 8px; transform: scale(0.9); transform-origin: bottom left; }
        #pitch-wrapper { bottom: 20px; right: 10px; padding: 8px; transform: scale(0.9); transform-origin: bottom right; width: 100px; }

        /* Les contrôles du haut restent visibles */
        #top-controls { top: 20px; padding: 5px 10px; background: rgba(0,0,0,0.5); border-radius: 8px; }
    }
    
    /* Classe pour le déplacement du vinyle en mode scratch sur desktop */
    .vinyl-scratch-desktop { left: 62.5% !important; width: 100% !important; height: 100% !important; }
    
</style>
</head>
<body>

    <div id="main-container" class="relative">

        <!-- Le conteneur de la platine -->
        <div id="turntable-container">
            
            <!-- Le disque vinyle (au centre, ou décalé en mode zoom/scratch) -->
            <div id="vinyl-image" class="touch-manipulation">
                <!-- Étiquette centrale SVG (Invisible) -->
                <svg viewBox="0 0 100 100" class="w-full h-full p-2">
                    <circle cx="50" cy="50" r="48" fill="#e74c3c"/>
                    <circle cx="50" cy="50" r="10" fill="#222"/>
                    <text x="50" y="50" dominant-baseline="middle" text-anchor="middle" font-size="8" fill="#fff" font-weight="bold">SCRATCH</text>
                </svg>
            </div>
            
            <!-- Contrôles du haut (Direction & Zoom) -->
            <div id="top-controls">
                <!-- Bouton Sens (Normal / Inversé) -->
                <button id="direction-button" class="control-button bg-gray-600 text-white hover:bg-gray-700">Sens: Normal</button>
                
                <!-- Bouton Zoom / Vue Centrée -->
                <button id="zoom-button" class="control-button bg-blue-500 text-white hover:bg-blue-600">Vue Centrée</button>
            </div>


            <!-- Le rectangle d'affichage (en haut à droite) -->
            <div id="overlay-box" class="overlay-hidden">
                <p class="text-xs text-white">Vitesse Actuelle:</p>
                <p id="current-rpm-display" class="text-xl font-bold">STOP</p>
                <span id="status-message">Chargement Audio...</span>
            </div>

            <!-- Contrôle RPM (Bas-Gauche) -->
            <div id="rpm-wrapper">
                <!-- 1. Étiquettes du haut (45 - OFF - 33) -->
                <div class="rpm-labels">
                    <span data-mode="45">45</span>
                    <span data-mode="off">ARRÊT</span>
                    <span data-mode="33">33</span>
                </div>

                <!-- 2. Contrôles de points au milieu -->
                <div id="rpm-controls">
                    <div class="rpm-choice" data-mode="45" title="45 RPM"></div>
                    <div class="rpm-choice active" data-mode="off" title="Arrêt"></div>
                    <!-- Clé '33' utilisée pour la vitesse 33 1/3 RPM -->
                    <div class="rpm-choice" data-mode="33" title="33 1/3 RPM"></div> 
                </div>

                <!-- 3. Image du bouton en bas -->
                <img id="rpm-img" 
                     src="https://tclaret.github.io/turntable/img/ChickenHead.png" 
                     alt="Bouton RPM"
                     style="transform: rotate(0deg);">
            </div>
            
            <!-- Pitch Control (Bas-Droite) -->
            <div id="pitch-wrapper">
                <label for="pitch-slider" class="block text-xs font-semibold mb-1 text-center">PITCH (± 10%)</label>
                <input type="range" id="pitch-slider" min="-0.1" max="0.1" step="0.001" value="0.0" class="w-full">
                <div id="pitch-value" class="text-center text-xs mt-1">0.00 %</div>
            </div>

        </div>

    </div>

    <script type="module">
        // --- CONFIGURATION ET INITIALISATION ---
        
        // Simuler la configuration Firebase/Auth (essentiel pour l'environnement Canvas)
        const __app_id = "default-app-id";
        const __firebase_config = '{}'; 
        const __initial_auth_token = undefined;
        
        // Configuration des vitesses de lecture de base (facteur pour Tone.js)
        const RPM_RATES = {"45": 1.35, "off": 0, "33": 1.0}; 
        const RPM_ROTATION = {"45": -30, "off": 0, "33": 30}; // Rotation visuelle du bouton
        
        // --- ÉTATS GLOBAUX ---
        let currentMode = "off";
        let pitchFactor = 1.0;
        let directionFactor = 1.0; // 1.0 = Normal, -1.0 = Inversé (détermine le signe de playbackRate)
        let targetBaseVelocity = 0; // Vitesse de lecture du moteur (RPM seulement)
        
        let isScratchMode = false; // False = Vue Centrée, True = Vue Zoom/Scratch
        
        // Variables pour le Scratch
        let isScratching = false;
        let lastX = 0;
        let rotationDegrees = 0; // Rotation visuelle cumulée en degrés
        let currentVelocity = 0; // Vitesse instantanée (pixels/frame)
        const VELOCITY_DECAY = 0.95; // Frottement (décélération)
        const VELOCITY_MULTIPLIER = 0.001; // Sensibilité du mouvement au taux de lecture audio
        
        // Variable pour gérer l'affichage de l'overlay
        let overlayTimeoutId = null; 
        
        // --- ÉLÉMENTS DU DOM ---
        const turntableContainer = document.getElementById('turntable-container');
        const vinylImage = document.getElementById('vinyl-image');
        const rpmChoices = document.querySelectorAll('.rpm-choice');
        const rpmImg = document.getElementById('rpm-img');
        const currentRpmDisplay = document.getElementById('current-rpm-display');
        const statusMessage = document.getElementById('status-message');
        const pitchSlider = document.getElementById('pitch-slider');
        const pitchValueDisplay = document.getElementById('pitch-value');
        const directionButton = document.getElementById('direction-button');
        const zoomButton = document.getElementById('zoom-button');
        const rpmWrapper = document.getElementById('rpm-wrapper');
        const overlayBox = document.getElementById('overlay-box');


        // --- LOGIQUE D'AFFICHAGE/MASQUAGE DE L'OVERLAY ---

        const showOverlayBriefly = () => {
            // 1. Annuler tout masquage en cours
            if (overlayTimeoutId) {
                clearTimeout(overlayTimeoutId);
            }
            
            // 2. Afficher l'overlay immédiatement
            overlayBox.classList.remove('overlay-hidden');
            
            // 3. Définir un nouveau timeout pour masquer après 1.5 seconde
            overlayTimeoutId = setTimeout(() => {
                overlayBox.classList.add('overlay-hidden');
            }, 1500); // 1500ms = 1.5 seconde
        };

        // --- CONFIGURATION AUDIO TONE.JS ---
        let player = null;
        let normalBuffer = null; 
        let audioContextStarted = false;
        
        // Fonction pour charger l'audio
        async function loadAudio() {
            statusMessage.textContent = "Chargement de la piste...";
            showOverlayBriefly();

            const audioUrl = "https://tclaret.github.io/turntable/JB_Cold_Sweat.opus";
            
            try {
                // 1. Charger le buffer normal
                normalBuffer = await new Tone.Buffer(audioUrl, 
                    // Succès
                    () => {
                        statusMessage.textContent = "Piste chargée. Prêt à jouer !";
                        showOverlayBriefly();
                        
                        // 2. Créer le lecteur Tone.js (une fois le buffer chargé)
                        try {
                            player = new Tone.Player(normalBuffer).toDestination();
                            player.loop = true;
                            player.playbackRate = 0; // Initialement à l'arrêt
                            player.start(0); 
                            
                            statusMessage.textContent = "Prêt. Cliquez sur 33 ou 45 !";
                            showOverlayBriefly();
                        } catch (e) {
                            console.error("Erreur lors de la création du lecteur Tone.js:", e);
                            statusMessage.textContent = "Erreur (Lecteur Audio).";
                            showOverlayBriefly();
                        }
                    },
                    // Erreur
                    (error) => {
                        console.error("Erreur de chargement audio (CORS/MIME type OPUS):", error);
                        statusMessage.textContent = "Erreur de chargement.";
                        showOverlayBriefly();
                    }
                );
            } catch (error) {
                console.error("Erreur Tone.js:", error);
                statusMessage.textContent = "Erreur critique.";
                showOverlayBriefly();
            }
        }

        // --- GESTION DU MODE RPM & VITESSE ---

        // Met à jour la vitesse de lecture audio en fonction du RPM, du Pitch et de la Direction
        const updatePlaybackRate = () => {
            if (!player || !player.loaded) return;

            let finalRate = 0;
            
            if (isScratching) {
                // Vitesse audio basée sur le mouvement du doigt * facteur de direction
                finalRate = currentVelocity * directionFactor; 
            } else {
                // Vitesse du moteur: RPM * Pitch * Direction
                finalRate = targetBaseVelocity * pitchFactor * directionFactor;
            }
            
            // Appliquer la vitesse au lecteur Tone.js
            player.playbackRate = finalRate;
        };


        // Fonction principale pour définir le mode RPM
        const setRpmMode = (mode) => {
            if (!player || !player.loaded) return;
            // Si le mode change réellement, ou si on passe de l'arrêt au même mode
            if (currentMode === mode && mode !== 'off') return; 

            currentMode = mode;
            
            // 1. Mise à jour des points lumineux
            rpmChoices.forEach(c => c.classList.remove('active'));
            document.querySelector(`.rpm-choice[data-mode='${mode}']`).classList.add('active');

            // 2. Mise à jour de la rotation du bouton (Chicken Head)
            rpmImg.style.transform = `rotate(${RPM_ROTATION[mode]}deg)`;
            
            // 3. Mise à jour de l'état du vinyle, de l'audio et de l'affichage
            if (mode === 'off') {
                targetBaseVelocity = 0;
                currentRpmDisplay.textContent = 'STOP';
                statusMessage.textContent = "Arrêté, prêt à jouer.";
            } else {
                targetBaseVelocity = RPM_RATES[mode];
                currentRpmDisplay.textContent = mode + ' tours';
                statusMessage.textContent = (directionFactor > 0) ? "En Lecture" : "Lecture Inversée";
            }
            
            // Afficher l'overlay
            showOverlayBriefly();

            // Mettre à jour la vitesse de lecture (qui gère l'audio)
            updatePlaybackRate();
        };

        // --- GESTION DU PITCH ---
        
        pitchSlider.addEventListener('input', () => {
            pitchFactor = 1.0 + parseFloat(pitchSlider.value);
            pitchValueDisplay.textContent = (parseFloat(pitchSlider.value) * 100).toFixed(2) + ' %';
            updatePlaybackRate();
        });

        // --- GESTION DE LA DIRECTION (NORMAL/INVERSÉ) ---

        directionButton.addEventListener('click', () => {
            directionFactor *= -1; // Basculer entre 1.0 et -1.0
            
            // Mise à jour de l'interface
            if (directionFactor === 1.0) {
                directionButton.textContent = 'Sens: Normal';
                directionButton.classList.remove('bg-red-700');
                directionButton.classList.add('bg-gray-600');
                if (currentMode !== 'off') statusMessage.textContent = 'En Lecture';
            } else {
                directionButton.textContent = 'Sens: Inversé';
                directionButton.classList.remove('bg-gray-600');
                directionButton.classList.add('bg-red-700');
                if (currentMode !== 'off') statusMessage.textContent = 'Lecture Inversée';
            }
            
            // Afficher l'overlay
            showOverlayBriefly();

            // Mise à jour de la vitesse (la rate négative gère l'audio inversé)
            updatePlaybackRate();
        });


        // --- LOGIQUE DE POSITIONNEMENT SCRATCH/ZOOM ---
        
        const isMobile = () => window.innerWidth <= 768;

        const updateScratchModeUI = () => {
            if (isMobile()) {
                if (isScratchMode) {
                    vinylImage.classList.add('centered-mobile');
                    zoomButton.textContent = 'Vue Centrée'; 
                } else {
                    vinylImage.classList.remove('centered-mobile');
                    zoomButton.textContent = 'Zoom'; 
                }
                rpmWrapper.classList.remove('rpm-scratch-centered');
            } else {
                if (isScratchMode) {
                    vinylImage.classList.add('vinyl-scratch-desktop');
                    rpmWrapper.classList.add('rpm-scratch-centered');
                    zoomButton.textContent = 'Vue Centrée';
                } else {
                    vinylImage.classList.remove('vinyl-scratch-desktop');
                    rpmWrapper.classList.remove('rpm-scratch-centered');
                    zoomButton.textContent = 'Zoom';
                }
            }
        };
        
        zoomButton.addEventListener('click', () => {
            isScratchMode = !isScratchMode;
            updateScratchModeUI();
        });
        
        window.addEventListener('resize', updateScratchModeUI);


        // --- LOGIQUE DE SCRATCH (Souris & Touch) ---
        
        const startScratch = (clientX) => {
            if (!player || currentMode === 'off' || !player.loaded) return;
            
            if (!audioContextStarted) {
                Tone.start();
                audioContextStarted = true;
                statusMessage.textContent = "Contexte audio démarré.";
                showOverlayBriefly();
            }

            isScratching = true;
            lastX = clientX;
            currentVelocity = 0; 
            vinylImage.style.cursor = 'grabbing';
            
            // Mettre à jour l'affichage de la vitesse instantanée
            currentRpmDisplay.textContent = 'SCRATCH';
            statusMessage.textContent = (directionFactor > 0) ? "Lecture Manuelle" : "Lecture Manuelle Inv.";
            showOverlayBriefly();

            updatePlaybackRate(); 
        };

        const moveScratch = (clientX) => {
            if (!isScratching) return;

            const deltaX = clientX - lastX;
            lastX = clientX;

            currentVelocity = deltaX * VELOCITY_MULTIPLIER;
            
            updatePlaybackRate();
        };

        const endScratch = () => {
            if (!isScratching) return;
            
            isScratching = false;
            updatePlaybackRate(); 
            
            vinylImage.style.cursor = 'grab';

            // Afficher l'état du moteur RPM
            currentRpmDisplay.textContent = currentMode === 'off' ? 'STOP' : currentMode + ' tours';
            statusMessage.textContent = currentMode === 'off' ? "Arrêté, prêt à jouer." : (directionFactor > 0) ? "En Lecture" : "Lecture Inversée";
            showOverlayBriefly();
        };
        
        // --- ÉVÉNEMENTS MOUSE ET TOUCH ---
        
        vinylImage.addEventListener('mousedown', (e) => startScratch(e.clientX));
        turntableContainer.addEventListener('mousemove', (e) => moveScratch(e.clientX));
        turntableContainer.addEventListener('mouseup', endScratch);
        turntableContainer.addEventListener('mouseleave', endScratch);
        
        vinylImage.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) { startScratch(e.touches[0].clientX); }
        });
        turntableContainer.addEventListener('touchmove', (e) => {
            if (e.touches.length === 1) { moveScratch(e.touches[0].clientX); }
        });
        turntableContainer.addEventListener('touchend', endScratch);
        turntableContainer.addEventListener('touchcancel', endScratch);


        // --- BOUCLE D'ANIMATION VISUELLE (VSYNC) ---
        
        function animate() {
            requestAnimationFrame(animate);

            // 1. Calculer la vitesse visuelle à partir de la vitesse audio
            let visualSpeed = 0;
            const currentAudioRate = player && player.loaded ? player.playbackRate : 0;
            
            if (isScratching) {
                // Rotation visuelle basée sur la vitesse du doigt
                visualSpeed = currentVelocity * 500; 
                currentVelocity *= VELOCITY_DECAY;
            } else if (currentMode !== 'off' || Math.abs(currentAudioRate) > 0.0001) {
                // Rotation par le moteur (la rate négative inverse la rotation)
                visualSpeed = currentAudioRate * 5; 
            } else {
                // Arrêt complet
                visualSpeed = 0;
            }

            // 2. Appliquer la rotation
            rotationDegrees += visualSpeed;
            vinylImage.style.transform = `translate(-50%, -50%) rotate(${rotationDegrees}deg)`;
        }


        // --- INITIALISATION GLOBALE ---

        // RPM Click Handlers 
        rpmChoices.forEach(choice => {
            choice.addEventListener('click', () => {
                const mode = choice.getAttribute('data-mode');
                setRpmMode(mode);
            });
        });
        
        // Chicken Head Click Handler
        rpmImg.addEventListener('click', () => {
            if (currentMode === 'off') {
                setRpmMode('33'); 
            } else {
                setRpmMode(currentMode === '33' ? '45' : '33');
            }
        });

        window.onload = function() {
            loadAudio();
            animate();
            
            // Initialiser l'état visuel du mode scratch/zoom (Zoom Mode par défaut sur Desktop)
            isScratchMode = isMobile() ? false : true; 
            updateScratchModeUI();
        }

    </script>
</body>
</html>
