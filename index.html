<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Turntable (Smooth Version)</title>
    <link rel="icon" href="data:,">
    <style>

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #333;
            user-select: none;
            color: white;
            font-family: Arial;
        }

        h1 {
            position: absolute;
            top: 5%;
            font-size: 24px;
            text-align: center;
            width: 100%;
        }

        #turntable-container {
            position: relative;
            width: 80vw; height: 80vw;
            max-width: 700px; max-height: 700px;
            background-color: #a08c78;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
            transition: transform 0.3s ease-in-out;
            overflow: hidden;
        }

        .zoomed-view { transform: scale(1.3); }

        #vinyl {
            width: 90%;
            height: 90%;
            border-radius: 50%;
            position: absolute;
            cursor: grab;
            top: 5%; left: 5%;
            transform: rotate(0deg);
        }

        #controls-wrapper {
            position: absolute;
            width: 100%; height: 100%;
            pointer-events: none;
        }

        button {
            pointer-events: auto;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }

        #stop-button {
            background: #c0392b;
            position: absolute; top: 20px; left: 20px;
        }

        #zoom-button {
            background: #3498db;
            position: absolute; top: 20px; left: 120px;
        }

        #speed-control, #pitch-control {
            position: absolute;
            bottom: 30px;
            font-size: 14px;
            pointer-events: auto;
            display: flex;
            align-items: center;
        }

        #speed-control { left: 20px; }
        #pitch-control { right: 20px; }

        .knob-container {
            display: flex;
            background: #222;
            padding: 5px;
            margin-left: 10px;
            border-radius: 10px;
        }

        .knob-container input { display: none; }

        .knob-container label {
            background: #555;
            color: white;
            padding: 5px 10px;
            margin: 0 2px;
            border-radius: 5px;
            cursor: pointer;
        }

        .knob-container input:checked + label {
            background: #1abc9c;
            font-weight: bold;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 150px;
            height: 10px;
            background: #ccc;
            border-radius: 5px;
            margin-left: 10px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px; height: 22px;
            background: #2c3e50;
            border-radius: 3px;
            cursor: pointer;
        }

    </style>
</head>

<body>

<h1>Loading Audio… tap to enable audio on mobile.</h1>

<div id="turntable-container">

    <img id="vinyl" src="img/DISC.png">

    <div id="controls-wrapper">

        <button id="stop-button">STOP</button>
        <button id="zoom-button">ZOOM</button>

        <div id="speed-control">
            SPEED:
            <div class="knob-container">
                <input type="radio" id="speed-45" name="rpm" value="45">
                <label for="speed-45">45</label>

                <input type="radio" id="speed-off" name="rpm" value="off" checked>
                <label for="speed-off">OFF</label>

                <input type="radio" id="speed-33" name="rpm" value="33">
                <label for="speed-33">33</label>
            </div>
        </div>

        <div id="pitch-control">
            PITCH:
            <input type="range" id="pitch-slider" min="-10" max="10" value="0">
            <span id="pitch-value">0%</span>
        </div>

    </div>

</div>

<script>
/* ---------------------------------------------------
          VARIABLES PRINCIPALES
--------------------------------------------------- */

const vinyl = document.getElementById("vinyl");
const napis = document.querySelector("h1");
const turntable = document.getElementById("turntable-container");

const rpmButtons = document.querySelectorAll('input[name="rpm"]');
const pitchSlider = document.getElementById("pitch-slider");
const pitchValue = document.getElementById("pitch-value");

let audioContext, audioBuffer, audioSource;

let center = {x: 0, y: 0};
let isDragging = false;

let currentRotation = 0;

/* vitesse moteur physique */
let velocity = 0;          // degrés par frame
let targetVelocity = 0;    // degrés par frame
let smoothing = 0.08;      // inertie

/* AUDIO */
const SCRATCH_SENS = 0.04;
const BASE_RATE_33 = 0.9;
const BASE_RATE_45 = 1.2;
let baseRate = BASE_RATE_33;
let pitchOffset = 0;

/* --------------------------------------------
            ROTATION + MOTEUR PHYSIQUE
-------------------------------------------- */

function engineLoop() {

    /* inertie : on va vers la vitesse cible */
    velocity += (targetVelocity - velocity) * smoothing;

    currentRotation += velocity;
    if (currentRotation >= 360) currentRotation -= 360;
    if (currentRotation < 0) currentRotation += 360;

    vinyl.style.transform = `rotate(${currentRotation}deg)`;

    /* synchro audio */
    if (audioSource) {
        const rate = baseRate + (velocity * SCRATCH_SENS) + pitchOffset;
        audioSource.playbackRate.setValueAtTime(Math.max(0.05, rate), audioContext.currentTime);
    }

    requestAnimationFrame(engineLoop);
}

requestAnimationFrame(engineLoop);

/* --------------------------------------------
                RPM SELECTION
-------------------------------------------- */

function setRPM(mode) {

    if (mode === "33") {
        baseRate = BASE_RATE_33;
        targetVelocity = 360 / 1.8 / 60;   // deg/frame
    }
    else if (mode === "45") {
        baseRate = BASE_RATE_45;
        targetVelocity = 360 / 1.3 / 60;
    }
    else {
        targetVelocity = 0;
    }

}

rpmButtons.forEach(btn=>{
    btn.addEventListener("change", ()=>setRPM(btn.value));
});

/* --------------------------------------------
                    SCRATCH
-------------------------------------------- */

function updateCenter() {
    const r = turntable.getBoundingClientRect();
    center.x = r.left + r.width/2;
    center.y = r.top + r.height/2;
}

function angleAt(e){
    const x = (e.touches?e.touches[0].clientX:e.clientX);
    const y = (e.touches?e.touches[0].clientY:e.clientY);
    return Math.atan2(y-center.y, x-center.x)*180/Math.PI;
}

let lastAngle = 0;

function startDrag(e){
    if (document.querySelector('input[name="rpm"]:checked').value === "off") return;

    isDragging = true;
    updateCenter();

    lastAngle = angleAt(e);
}

function drag(e){
    if (!isDragging) return;

    const a = angleAt(e);
    const delta = a - lastAngle;
    lastAngle = a;

    currentRotation += delta;
    vinyl.style.transform = `rotate(${currentRotation}deg)`;

    velocity = delta;       // vitesse instantanée
    targetVelocity = delta; // reste dans ce sens jusqu’à relâchement
}

function stopDrag(){
    if (!isDragging) return;
    isDragging = false;

    // retour à la vitesse RPM
    const mode = document.querySelector('input[name="rpm"]:checked').value;
    setRPM(mode);
}

/* --------------------------------------------
                PITCH SLIDER
-------------------------------------------- */

pitchSlider.addEventListener("input", ()=>{
    pitchOffset = parseInt(pitchSlider.value)/100;
    pitchValue.textContent = pitchSlider.value+"%";
});

/* --------------------------------------------
                AUDIO LOADING
-------------------------------------------- */

async function loadAudio(url){
    audioContext = new AudioContext();
    napis.textContent = "Loading audio…";

    const response = await fetch(url);
    const data = await response.arrayBuffer();
    audioBuffer = await audioContext.decodeAudioData(data);

    napis.textContent = "Ready. Pick an RPM.";

    startAudio(BASE_RATE_33);
}

function startAudio(rate){
    if (audioSource) audioSource.stop();

    audioSource = audioContext.createBufferSource();
    audioSource.buffer = audioBuffer;
    audioSource.loop = true;
    audioSource.connect(audioContext.destination);
    audioSource.playbackRate.value = rate;
    audioSource.start(0);
}

/* --------------------------------------------
                BUTTONS
-------------------------------------------- */

document.getElementById("stop-button").onclick = ()=>{
    document.getElementById("speed-off").checked = true;
    setRPM("off");
};

document.getElementById("zoom-button").onclick = ()=>{
    turntable.classList.toggle("zoomed-view");
    setTimeout(updateCenter, 300);
};

/* --------------------------------------------
            EVENTS
-------------------------------------------- */

vinyl.addEventListener("mousedown", startDrag);
vinyl.addEventListener("mousemove", drag);
window.addEventListener("mouseup", stopDrag);

vinyl.addEventListener("touchstart", startDrag);
vinyl.addEventListener("touchmove", drag);
vinyl.addEventListener("touchend", stopDrag);

window.addEventListener("resize", updateCenter);

window.addEventListener("load", ()=>{
    updateCenter();
    loadAudio("vinyl.mp3");
});

</script>
</body>
</html>
