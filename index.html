<!DOCTYPE html>
<html lang="fr">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Platine Vinyle Interactive Complète v19</title>

<!-- Tailwind CSS et Tone.js -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Creepster&display=swap" rel="stylesheet">

<style>
    /* Configuration du fond et de la police */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #1a1a2e; 
        color: #ffffff;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden; 
        padding: 0; 
    }
    
    #turntable-container {
        position: relative;
        width: 90vmin;
        height: 90vmin;
        max-width: 900px;
        max-height: 900px;
        background: #333; 
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        overflow: hidden;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    /* Styles pour le VINYLE */
    #vinyl-image {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); 
        width: 80%;
        height: 80%;
        border-radius: 50%;
        background-image: url('https://tclaret.github.io/turntable/img/DISC.png');
        background-size: cover;
        background-position: center;
        border: 1px solid #111;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 10px rgba(0, 0, 0, 0.9);
        z-index: 10;
        cursor: grab;
        touch-action: none; 
        transition: none;
    }
    
    #vinyl-image svg {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 25%; 
        height: 25%;
        opacity: 0; 
        pointer-events: none;
    }

    /* ---------------------------------------------------- */
    /* CONTROLES UNIFIÉS (Haut-Gauche) */
    /* ---------------------------------------------------- */
    .control-panel {
        position: absolute;
        top: 15px;
        left: 15px;
        display: flex;
        flex-wrap: wrap; 
        align-items: center;
        gap: 8px;
        z-index: 60; 
        background: rgba(0, 0, 0, 0.6);
        padding: 8px;
        border-radius: 8px;
        max-width: 60%; 
    }
    
    /* Boutons Compacts */
    .vintage-btn {
        padding: 6px 10px; 
        border: 1px solid #555;
        border-radius: 4px;
        background: linear-gradient(to bottom, #e0e0e0 0%, #b0b0b0 100%);
        color: #333;
        font-size: 11px; 
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        transition: transform 0.1s;
        white-space: nowrap;
        min-width: 40px; 
        text-align: center;
    }

    .vintage-btn:active {
        transform: translateY(1px);
        background: linear-gradient(to bottom, #b0b0b0 0%, #999 100%);
    }
    
    .vintage-btn.active-state {
        background: linear-gradient(to bottom, #aaddff 0%, #6699cc 100%);
        box-shadow: inset 0 0 5px #3498db;
        color: #000;
    }
    
    /* Style spécifique pour le bouton reverse actif (rouge + police spéciale) */
    .vintage-btn.reverse-active {
        background: linear-gradient(to bottom, #ff9999 0%, #cc0000 100%);
        color: white;
        text-shadow: 0 1px 3px rgba(0,0,0,1);
        /* POLICE SPÉCIALE */
        font-family: 'Creepster', cursive;
        font-size: 14px; 
        letter-spacing: 1px;
        border-color: #600;
    }


    /* ---------------------------------------------------- */
    /* OVERLAY (Haut-Droit) - Dégagé */
    /* ---------------------------------------------------- */
    #overlay-box {
        position: absolute; 
        top: 15px; 
        right: 15px; 
        width: auto; 
        min-width: 80px;
        padding: 8px 12px;
        background-color: rgba(60, 60, 80, 0.85); 
        border-radius: 6px;
        display: flex; 
        flex-direction: column; 
        justify-content: center;
        align-items: center; 
        z-index: 55; 
        transition: opacity 0.5s ease-out;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .overlay-hidden { opacity: 0; pointer-events: none; }
    
    #current-rpm-display {
        font-size: 16px;
        font-weight: bold;
        letter-spacing: 1px;
        color: #fff;
        text-shadow: 0 0 5px rgba(0,0,0,0.5);
    }

    /* ---------------------------------------------------- */
    /* STYLES RPM (Bas-Gauche) */
    /* ---------------------------------------------------- */
    #rpm-wrapper {
        position: absolute; bottom: 5%; left: 5%; width: auto;
        display: flex; flex-direction: column; align-items: center;     
        gap: 8px; z-index: 50; background: rgba(0,0,0,0.3); 
        padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
        transition: left 0.5s ease-in-out, padding 0.3s ease;
    }
    
    .rpm-scratch-centered { left: 15% !important; }

    .rpm-labels {
        display:flex; justify-content:space-between; width: 90px; font-size: 10px;
        font-family: sans-serif; font-weight: bold; color: #d0d0d0;
        text-shadow: 0 1px 2px black; pointer-events: none;
    }
    .rpm-labels span { width: 25px; text-align: center; }

    #rpm-controls { display:flex; justify-content:space-between; width: 90px; position: relative; }

    .rpm-choice {
        width: 16px; height: 16px; border-radius: 50%; background: #444; border: 2px solid #222;
        cursor: pointer; box-shadow: inset 0 2px 3px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.2);
        transition: background 0.2s; margin: 0 auto; 
    }
    .rpm-choice:hover { background: #666; }
    .rpm-choice.active { 
        background: #00ff00; 
        box-shadow: 0 0 10px #00ff00, inset 0 2px 3px rgba(0,0,0,0.5);
        border-color: #003300;
    }

    #rpm-img {
        width: 30px; height: auto; display: block;
        transform-origin: center center;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.7));
    }

    /* ---------------------------------------------------- */
    /* PITCH CONTROL (Bas-Droite) */
    /* ---------------------------------------------------- */
    #pitch-wrapper {
        position: absolute; bottom: 5%; right: 5%; 
        width: 180px;
        background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1); z-index: 50;
    }
    #pitch-slider {
        -webkit-appearance: none; width: 100%; height: 6px; background: #444;
        border-radius: 3px; outline: none; cursor: pointer;
    }
    #pitch-slider::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none; width: 16px; height: 28px; 
        border-radius: 3px; background: #00bcd4; cursor: pointer;
        box-shadow: 0 0 5px rgba(0, 188, 212, 0.8), inset 0 1px 3px rgba(255,255,255,0.4);
    }

    #pitch-scale { position: relative; height: 15px; margin-top: 5px; }
    .pitch-mark {
        position: absolute; top: 0; height: 100%; display: flex; flex-direction: column;
        align-items: center; color: #aaa; font-size: 9px; font-weight: bold;
    }
    .pitch-mark::before { content: '|'; display: block; line-height: 1; font-size: 10px; height: 5px; }
    .pitch-mark.center { color: #00ff00; }

    #mark-neg-10 { left: 0%; transform: translateX(-50%); }
    #mark-neg-05 { left: 25%; transform: translateX(-50%); }
    #mark-zero { left: 50%; transform: translateX(-50%); }
    #mark-pos-05 { left: 75%; transform: translateX(-50%); }
    #mark-pos-10 { left: 100%; transform: translateX(-50%); }
    
    
    /* ---------------------------------------------------- */
    /* MOBILE (< 768px) */
    /* ---------------------------------------------------- */
    @media (max-width: 768px) {
        #vinyl-image { left: 70%; width: 140%; height: 140%; }
        #vinyl-image.centered-mobile { left: 50%; width: 80%; height: 80%; }

        #rpm-wrapper { bottom: 20px; left: 10px; padding: 8px; transform: scale(0.9); transform-origin: bottom left; }
        #pitch-wrapper { bottom: 20px; right: 10px; padding: 8px; transform: scale(0.9); transform-origin: bottom right; width: 140px; }

        .control-panel {
            top: 10px; left: 10px; max-width: 65%; 
            gap: 5px; padding: 5px 8px;
        }
        .vintage-btn { padding: 5px 8px; font-size: 10px; }
        
        #overlay-box { top: 10px; right: 10px; padding: 5px 8px; }
        #current-rpm-display { font-size: 12px; }
    }
    
    .vinyl-scratch-desktop { left: 70% !important; width: 140% !important; height: 140% !important; }
    
</style>
</head>
<body>

    <div id="main-container" class="relative">

        <!-- Le conteneur de la platine -->
        <div id="turntable-container">
            
            <!-- Le disque vinyle -->
            <div id="vinyl-image" class="touch-manipulation"></div>
            
            <!-- Contrôles Unifiés (Haut-Gauche) -->
            <div class="control-panel">
                <button id="stop-button" class="vintage-btn">Arrêt</button>
                <button id="direction-button" class="vintage-btn">!</button> <!-- ! = Normal -->
                <button id="zoom-button" class="vintage-btn">Vue Scratch</button>
            </div>

            <!-- Overlay (Haut-Droit) -->
            <div id="overlay-box" class="overlay-hidden">
                <p id="current-rpm-display">STOP</p>
            </div>

            <!-- Contrôle RPM (Bas-Gauche) -->
            <div id="rpm-wrapper">
                <div class="rpm-labels">
                    <span data-mode="45">45</span>
                    <span data-mode="off">ARRÊT</span>
                    <span data-mode="33">33</span>
                </div>
                <div id="rpm-controls">
                    <div class="rpm-choice" data-mode="45" title="45 RPM"></div>
                    <div class="rpm-choice active" data-mode="off" title="Arrêt"></div>
                    <div class="rpm-choice" data-mode="33" title="33 1/3 RPM"></div> 
                </div>
                <img id="rpm-img" 
                     src="https://tclaret.github.io/turntable/img/ChickenHead.png" 
                     alt="Bouton RPM"
                     style="transform: rotate(0deg);">
            </div>
            
            <!-- Pitch Control (Bas-Droite) -->
            <div id="pitch-wrapper">
                <label for="pitch-slider" class="block text-xs font-semibold mb-1 text-center">PITCH (± 10%)</label>
                <input type="range" id="pitch-slider" min="-0.1" max="0.1" step="0.001" value="0.0" class="w-full">
                <div id="pitch-scale">
                    <span class="pitch-mark" id="mark-neg-10">-10</span>
                    <span class="pitch-mark" id="mark-neg-05">-5</span>
                    <span class="pitch-mark center" id="mark-zero">0</span>
                    <span class="pitch-mark" id="mark-pos-05">+5</span>
                    <span class="pitch-mark" id="mark-pos-10">+10</span>
                </div>
                <div id="pitch-value" class="text-center text-xs mt-1">0.00 %</div>
            </div>

        </div>

    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const RPM_RATES = {"45": 1.35, "off": 0, "33": 1.0}; 
        const RPM_ROTATION = {"45": -30, "off": 0, "33": 30};
        
        // --- ÉTATS GLOBAUX ---
        let currentMode = "off";
        let pitchFactor = 1.0;
        let directionFactor = 1.0; 
        let targetBaseVelocity = 0; 
        let isScratchMode = false; 
        
        // Scratch
        let isScratching = false;
        let lastAngle = 0; 
        let rotationDegrees = 0; 
        let currentScratchVelocity = 0; 
        
        const ANGULAR_MULTIPLIER = 0.3; 
        const VISUAL_RPM_MULTIPLIER = 3.3333; 
        const REVERSE_SEEK_OFFSET = 0.05; 
        
        // Audio
        let player = null;
        let normalBuffer = null; 
        let audioContextStarted = false;
        let bufferDuration = 0; 
        let overlayTimeoutId = null; 
        
        // --- DOM ---
        const turntableContainer = document.getElementById('turntable-container');
        const vinylImage = document.getElementById('vinyl-image');
        const rpmChoices = document.querySelectorAll('.rpm-choice');
        const rpmLabels = document.querySelectorAll('.rpm-labels span');
        const rpmImg = document.getElementById('rpm-img');
        const currentRpmDisplay = document.getElementById('current-rpm-display');
        const pitchSlider = document.getElementById('pitch-slider');
        const pitchValueDisplay = document.getElementById('pitch-value');
        const directionButton = document.getElementById('direction-button');
        const zoomButton = document.getElementById('zoom-button');
        const stopBtn = document.getElementById('stop-button');
        const rpmWrapper = document.getElementById('rpm-wrapper');
        const overlayBox = document.getElementById('overlay-box');
        const audioErrorDiv = document.getElementById('audio-error');

        // --- OVERLAY ---
        const showOverlayBriefly = () => {
            if (overlayTimeoutId) clearTimeout(overlayTimeoutId);
            overlayBox.classList.remove('overlay-hidden');
            overlayTimeoutId = setTimeout(() => {
                overlayBox.classList.add('overlay-hidden');
            }, 1500);
        };

        // --- AUDIO ---
        const updatePlaybackRate = () => {
            if (!player || !player.loaded) return;
            let finalRate = 0;
            if (isScratching) {
                finalRate = currentScratchVelocity * directionFactor; 
            } else {
                finalRate = targetBaseVelocity * pitchFactor * directionFactor;
            }
            
            // CORRECTION : Séparer la vitesse (valeur absolue) de la direction (reverse bool)
            const speed = Math.abs(finalRate);
            const isReverse = finalRate < 0;

            // Limitation de sécurité
            const safeSpeed = Math.min(speed, 10); // Max 10x speed
            
            player.playbackRate = safeSpeed;
            player.reverse = isReverse;
        };

        async function loadAudio() {
            const audioUrl = "https://tclaret.github.io/turntable/JB_Cold_Sweat.opus";
            try {
                normalBuffer = await new Tone.Buffer(audioUrl, 
                    () => {
                        bufferDuration = normalBuffer.duration;
                        try {
                            player = new Tone.Player(normalBuffer).toDestination();
                            player.loop = true;
                            player.playbackRate = 0; 
                            player.start(0); 
                        } catch (e) {
                            console.error("Erreur Player:", e);
                        }
                    },
                    (error) => {
                        console.error("Erreur Load:", error);
                        audioErrorDiv.style.display = 'block';
                    }
                );
            } catch (error) {
                console.error("Erreur Tone:", error);
            }
        }

        // --- CONTRÔLE RPM ---
        const setRpmMode = (mode) => {
            if (!player || !player.loaded) return;
            if (currentMode === mode && mode !== 'off') return; 

            currentMode = mode;
            rpmChoices.forEach(c => c.classList.remove('active'));
            document.querySelector(`.rpm-choice[data-mode='${mode}']`).classList.add('active');
            rpmImg.style.transform = `rotate(${RPM_ROTATION[mode]}deg)`;
            
            if (mode === 'off') {
                targetBaseVelocity = 0;
                currentRpmDisplay.textContent = 'STOP';
            } else {
                targetBaseVelocity = RPM_RATES[mode];
                currentRpmDisplay.textContent = mode + ' RPM';
            }
            showOverlayBriefly();
            updatePlaybackRate();
        };

        // --- PITCH ---
        pitchSlider.addEventListener('input', () => {
            pitchFactor = 1.0 + parseFloat(pitchSlider.value);
            pitchValueDisplay.textContent = (parseFloat(pitchSlider.value) * 100).toFixed(2) + ' %';
            if (!isScratching) updatePlaybackRate();
        });

        // --- DIRECTION ---
        directionButton.addEventListener('click', () => {
            directionFactor *= -1; 
            if (directionFactor === 1.0) {
                directionButton.textContent = '!'; // Normal
                directionButton.classList.remove('reverse-active');
            } else {
                directionButton.textContent = 'Reverse'; // Inversé
                directionButton.classList.add('reverse-active');
            }
            showOverlayBriefly();
            updatePlaybackRate();
        });

        // --- STOP BUTTON ---
        stopBtn.addEventListener('click', () => {
            setRpmMode('off');
        });

        // --- ZOOM / SCRATCH VIEW ---
        const isMobile = () => window.innerWidth <= 768;

        const updateScratchModeUI = () => {
            if (isMobile()) {
                if (isScratchMode) {
                    vinylImage.classList.add('centered-mobile');
                    zoomButton.textContent = 'Vue Centrée'; 
                } else {
                    vinylImage.classList.remove('centered-mobile');
                    zoomButton.textContent = 'Zoom'; 
                }
                rpmWrapper.classList.remove('rpm-scratch-centered');
            } else {
                if (isScratchMode) {
                    vinylImage.classList.add('vinyl-scratch-desktop');
                    rpmWrapper.classList.add('rpm-scratch-centered');
                    zoomButton.textContent = 'Vue Centrée';
                    turntableContainer.style.transform = "scale(1.7)";
                } else {
                    vinylImage.classList.remove('vinyl-scratch-desktop');
                    rpmWrapper.classList.remove('rpm-scratch-centered');
                    zoomButton.textContent = 'Zoom';
                    turntableContainer.style.transform = "scale(1)";
                }
            }
        };
        
        zoomButton.addEventListener('click', () => {
            isScratchMode = !isScratchMode;
            updateScratchModeUI();
        });
        window.addEventListener('resize', updateScratchModeUI);


        // --- LOGIQUE SCRATCH ---
        const getVinylCenter = () => {
            const rect = vinylImage.getBoundingClientRect();
            return { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
        };
        const getAngle = (x, y, centerX, centerY) => {
            const dx = x - centerX;
            const dy = y - centerY;
            return Math.atan2(dy, dx) * (180 / Math.PI);
        };
        
        const startScratch = (clientX, clientY) => {
            if (!player || currentMode === 'off' || !player.loaded) return;
            if (!audioContextStarted) {
                Tone.start();
                audioContextStarted = true;
            }
            isScratching = true;
            vinylImage.style.cursor = 'grabbing';
            const center = getVinylCenter();
            lastAngle = getAngle(clientX, clientY, center.x, center.y);
            currentRpmDisplay.textContent = 'SCRATCHING';
            showOverlayBriefly();
            updatePlaybackRate();
        };

        const moveScratch = (clientX, clientY) => {
            if (!isScratching) return;
            const center = getVinylCenter();
            const currentAngle = getAngle(clientX, clientY, center.x, center.y);
            let deltaAngle = currentAngle - lastAngle;
            if (deltaAngle > 180) deltaAngle -= 360;
            else if (deltaAngle < -180) deltaAngle += 360;

            currentScratchVelocity = deltaAngle * ANGULAR_MULTIPLIER;
            rotationDegrees += deltaAngle;
            lastAngle = currentAngle;
            updatePlaybackRate();
        };

        const endScratch = () => {
            if (!isScratching) return;
            isScratching = false;
            currentScratchVelocity = 0; 
            vinylImage.style.cursor = 'grab';
            updatePlaybackRate(); 
            currentRpmDisplay.textContent = currentMode === 'off' ? 'STOP' : currentMode + ' RPM';
            showOverlayBriefly();
        };
        
        vinylImage.addEventListener('mousedown', (e) => startScratch(e.clientX, e.clientY));
        turntableContainer.addEventListener('mousemove', (e) => moveScratch(e.clientX, e.clientY));
        turntableContainer.addEventListener('mouseup', endScratch);
        turntableContainer.addEventListener('mouseleave', endScratch);
        
        vinylImage.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) startScratch(e.touches[0].clientX, e.touches[0].clientY);
        });
        turntableContainer.addEventListener('touchmove', (e) => {
            e.preventDefault(); 
            if (e.touches.length === 1) moveScratch(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false }); 
        turntableContainer.addEventListener('touchend', endScratch);
        turntableContainer.addEventListener('touchcancel', endScratch);

        // --- ANIMATION LOOP ---
        let lastTime = performance.now(); 
        function animate() {
            requestAnimationFrame(animate);
            if (!player || !player.loaded || bufferDuration === 0) return;

            const now = performance.now(); 
            const dt = (now - lastTime) / 1000; 
            lastTime = now;
            
            // On récupère les valeurs appliquées via updatePlaybackRate
            const currentRate = player.playbackRate; 
            const isReverse = player.reverse;

            // Pour la visualisation, on combine vitesse et direction
            const effectiveVisualRate = currentRate * (isReverse ? -1 : 1);

            if (isScratching) {
                if (Math.abs(currentScratchVelocity) > 0.0001) currentScratchVelocity *= 0.95; 
            } else if (effectiveVisualRate !== 0) {
                rotationDegrees += effectiveVisualRate * VISUAL_RPM_MULTIPLIER * dt * 60; 
            }
            vinylImage.style.transform = `translate(-50%, -50%) rotate(${rotationDegrees}deg)`;
        }

        // --- INIT ---
        rpmChoices.forEach(choice => choice.addEventListener('click', () => setRpmMode(choice.dataset.mode)));
        rpmLabels.forEach(l => l.addEventListener('click', (e) => setRpmMode(e.target.dataset.mode)));
        rpmImg.addEventListener('click', () => setRpmMode(currentMode === 'off' ? '33' : (currentMode === '33' ? '45' : '33')));

        window.onload = function() {
            loadAudio();
            animate();
            isScratchMode = isMobile() ? false : true; 
            updateScratchModeUI();
        }
    </script>
</body>
</html>
