<!DOCTYPE html>
<html lang="fr">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Scratching  Viny</title>

<link rel="icon" type="image/x-icon" href="img/favicon.ico">


<style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
        height:100vh;
        background:#222;
        display:flex;
        flex-direction: column;
        justify-content:center;
        align-items:center;
        font-family: "Helvetica Neue", Arial, sans-serif;
        color:white;
        user-select:none;
        overflow: hidden;
    }

    #turntable-container {
        transition: transform 0.5s ease;
    }

    #turntable {
        position:relative;
        width:80vmin;
        height:80vmin;
        max-width:700px;
        max-height:700px;
        /* Couleur bois sombre */
        background: #634b32; 
        border-radius:12px;
        box-shadow:
            inset 0 0 0 10px rgba(0,0,0,0.2),
            0 20px 50px rgba(0,0,0,0.8);
        overflow:hidden;
    }

    /* Message d'erreur Audio */
    #audio-error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 15px;
        background: #cc0000;
        color: white;
        border-radius: 8px;
        font-weight: bold;
        text-align: center;
        z-index: 100;
        box-shadow: 0 0 20px rgba(0,0,0,0.8);
        display: none; /* Caché par défaut */
    }

    /* Panneau de contrôle général (Haut-Gauche) */
    .control-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        z-index: 50;
        background: rgba(0, 0, 0, 0.4);
        padding: 10px;
        border-radius: 8px;
    }
    
    /* Boutons de style vintage */
    .vintage-btn {
        padding: 8px 16px;
        border: 1px solid #444;
        border-radius: 4px;
        background: linear-gradient(to bottom, #e0e0e0 0%, #b0b0b0 100%);
        color: #333;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        box-shadow: 
            0 3px 5px rgba(0,0,0,0.5),
            inset 0 1px 0 rgba(255,255,255,0.8);
        transition: transform 0.1s, box-shadow 0.1s, background 0.2s;
        text-shadow: 0 1px 0 rgba(255,255,255,0.5);
    }

    .vintage-btn:active {
        transform: translateY(2px);
        box-shadow: 
            0 1px 2px rgba(0,0,0,0.5),
            inset 0 2px 5px rgba(0,0,0,0.2);
        background: linear-gradient(to bottom, #b0b0b0 0%, #999 100%);
    }
    
    /* État actif spécifique du bouton zoom */
    .vintage-btn.zoom-active {
        background: linear-gradient(to bottom, #aaddff 0%, #6699cc 100%);
        box-shadow: inset 0 0 10px #3498db;
    }


    /* --- Contrôle de la vitesse (Pitch) (Bas-Droit) --- */
    #pitch-control {
        position: absolute; 
        bottom: 20px;       
        right: 20px;        
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.4); 
        border: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 50;
        width: 120px; 
    }

    #pitch-control label {
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
        color: #ddd;
    }
    
    #pitch-slider {
        -webkit-appearance: none;
        width: 100px; 
        height: 8px;
        background: #333;
        outline: none;
        opacity: 0.9;
        -webkit-transition: .2s;
        transition: opacity .2s;
        border-radius: 4px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.8);
    }

    #pitch-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #f0f0f0;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0,0,0,0.5), inset 0 1px 0 #fff;
    }

    /* --- Échelle de Pitch --- */
    #pitch-scale {
        position: relative;
        width: 100px; 
        height: 10px;
        margin-top: 2px;
        margin-bottom: 5px;
    }

    .pitch-mark {
        position: absolute;
        bottom: 0;
        transform: translateX(-50%);
        height: 5px;
        width: 1px;
        background: #ccc;
    }

    .pitch-label {
        position: absolute;
        bottom: 5px;
        transform: translateX(-50%);
        font-size: 8px;
        color: #ccc;
        font-weight: normal;
        white-space: nowrap;
    }

    /* Marque longue pour le point zéro */
    .pitch-mark.zero {
        height: 8px;
        background: #00ff00; 
    }


    /* --- Disque vinyle --- */
    #vinyl {
        position:absolute;
        top:50%; left:50%;
        transform: translate(-50%, -50%);
        width:85%; height:85%;
        border-radius:50%;
        
        background-image: url('https://tclaret.github.io/turntable/img/DISC.png');
        background-size: cover;
        background-position: center;

        cursor:grab;
        will-change:transform;
        box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    }
    #vinyl:active { cursor:grabbing; }

    /* Conteneur RPM (Bas-Gauche) */
    #rpm-wrapper {
        position:absolute;
        bottom: 5%;
        left: 5%;
        width: auto;
        display: flex;
        flex-direction: column; 
        align-items: center;     
        gap: 8px;                
        z-index:45;
        background: rgba(0,0,0,0.2); 
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.1);
    }

    /* 1. Étiquettes du haut (45 - OFF - 33) */
    .rpm-labels {
        display:flex;
        justify-content:space-between;
        width: 90px; 
        font-size: 10px;
        font-family: sans-serif;
        font-weight: bold;
        color: #d0d0d0;
        text-shadow: 0 1px 2px black;
        pointer-events: none;
    }
    
    .rpm-labels span {
        width: 25px;
        text-align: center;
    }

    /* 2. Contrôles de points au milieu */
    #rpm-controls {
        display:flex;
        justify-content:space-between;
        width: 90px; 
        position: relative;
    }

    .rpm-choice {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #444;
        border: 2px solid #222;
        cursor: pointer;
        box-shadow: inset 0 2px 3px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.2);
        transition: background 0.2s;
        margin: 0 auto; 
    }

    .rpm-choice:hover { background: #666; }
    
    /* Lumière LED/Point actif */
    .rpm-choice.active { 
        background: #00ff00; 
        box-shadow: 0 0 10px #00ff00, inset 0 2px 3px rgba(0,0,0,0.5);
        border-color: #003300;
    }

    /* 3. Image du bouton en bas */
    #rpm-img {
        width: 30px; 
        height: auto;
        display: block;
        transform-origin: center center;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.7));
    }

</style>
</head>
<body>

<div id="turntable-container">
    <div id="turntable">
        
        <!-- Message d'erreur Audio -->
        <div id="audio-error">ERREUR AUDIO : Fichier JB.mp3 introuvable.</div>

        <!-- Panneau de contrôle (Haut-Gauche) -->
        <div class="control-panel">
            <button id="stop-button" class="vintage-btn">Arrêt</button>
            <button id="zoom-button" class="vintage-btn">Zoom</button>
        </div>
        
        <!-- Contrôle de la vitesse (Pitch) (Bas-Droit) -->
        <div id="pitch-control">
            <label for="pitch-slider">Pitch</label>
            <input type="range" min="-15" max="15" value="0" id="pitch-slider">
            <div id="pitch-scale">
                
                <!-- +15% -->
                <span class="pitch-mark" style="left:0%;"></span>
                <span class="pitch-label" style="left:0%;">+15%</span>

                <!-- +10% -->
                <span class="pitch-mark" style="left:16.67%;"></span>
                <span class="pitch-label" style="left:16.67%;">+10</span>

                <!-- 0% -->
                <span class="pitch-mark zero" style="left:50%;"></span>
                <span class="pitch-label" style="left:50%; top: 1px;">0</span>

                <!-- -10% -->
                <span class="pitch-mark" style="left:83.33%;"></span>
                <span class="pitch-label" style="left:83.33%;">-10</span>

                <!-- -15% -->
                <span class="pitch-mark" style="left:100%;"></span>
                <span class="pitch-label" style="left:100%;">-15%</span>
            </div>
        </div>


        <!-- Le disque vinyle -->
        <div id="vinyl" style="transform: rotate(0deg);">
            <!-- Le disque est rendu par l'image de fond -->
        </div>

        <!-- Contrôle RPM (Bas-Gauche) -->
        <div id="rpm-wrapper">
            <!-- 1. Étiquettes du haut (45 - OFF - 33) -->
            <div class="rpm-labels">
                <span>45</span>
                <span>ARRÊT</span>
                <span>33</span>
            </div>

            <!-- 2. Contrôles de points au milieu -->
            <div id="rpm-controls">
                <div class="rpm-choice" data-rpm="45" title="45 RPM"></div>
                <div class="rpm-choice active" data-rpm="off" title="Arrêt"></div>
                <!-- Clé '33' utilisée pour la vitesse 33 1/3 RPM -->
                <div class="rpm-choice" data-rpm="33" title="33 1/3 RPM"></div> 
            </div>

            <!-- 3. Image du bouton en bas -->
            <img id="rpm-img" 
                 src="https://tclaret.github.io/turntable/img/ChickenHead.png" 
                 alt="Bouton RPM"
                 style="transform: rotate(0deg);">
        </div>
    </div>
</div>

<script>
    const vinyl = document.getElementById("vinyl");
    const rpmImg = document.getElementById("rpm-img");
    const rpmChoices = document.querySelectorAll('.rpm-choice');
    const stopBtn = document.getElementById('stop-button');
    const zoomBtn = document.getElementById('zoom-button');
    const turntableContainer = document.getElementById('turntable-container');
    const pitchSlider = document.getElementById('pitch-slider');
    const audioErrorDiv = document.getElementById('audio-error'); 
    
    // Les références Gemini ont été retirées

    let currentRotation = 0;
    let velocity = 0;
    let targetBaseVelocity = 0; 
    let currentPitchFactor = 1.0; 
    let isDragging = false;
    let lastAngle = 0;
    let center = {x:0, y:0};
    
    // Constantes de physique
    const returnStrength = 0.08; 
    const dragSensitivity = 3.0; 
    const MAX_PLAYBACK_RATE = 2.5; 
    const MAX_SCRATCH_ACCELERATION = 0.5; 

    let isZoomed = false;

    // État Audio
    let audioCuePointSeconds = 0; 
    let isPlaying = false; 
    let audioDurationSeconds = 0; 
    
    let rpmMode = "off";
    // Calcul précis des degrés par frame (pour 60 FPS) :
    const RPM_BASE_SPEED = {"33": 360 / 60 / 60 * (100 / 3), "45": 4.5, "off": 0}; 
    const NORMAL_RPM_VELOCITY = RPM_BASE_SPEED["33"]; 

    // Configuration Audio
    let audioCtx = null;
    let buffer = null;
    let source = null;
    // URL AUDIO
    const audioURL = "https://tclaret.github.io/turntable/JB.mp3"; 

    function initAudio(){ 
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); 
    }
    
    /**
     * Convertit la rotation visuelle (en degrés) en un décalage audio (en secondes).
     */
    function rotationToAudioOffset(degrees, duration) {
        let offset = (degrees * duration / 360) % duration;
        if (offset < 0) {
            offset += duration;
        }
        return offset;
    }


    /*
     * Fonction ASYNC pour charger l'audio et démarrer la lecture.
     */
    async function startPlayback() {
        initAudio();
        if (audioCtx.state === 'suspended') {
            await audioCtx.resume();
        }

        if(!buffer) {
            try {
                const res = await fetch(audioURL); 
                // Vérifier si la réponse est un succès HTTP (statut 200-299)
                if(!res.ok) throw new Error("Audio file not found: " + audioURL);
                const arr = await res.arrayBuffer(); 
                buffer = await audioCtx.decodeAudioData(arr); 
                audioDurationSeconds = buffer.duration; 
                audioErrorDiv.style.display = 'none'; 
            } catch(e) {
                console.error("Échec du chargement ou du décodage audio:", e);
                // Mettre à jour le message d'erreur avec l'URL complète
                audioErrorDiv.innerHTML = `ERREUR AUDIO : Fichier <br> ${audioURL} <br> introuvable.`; 
                audioErrorDiv.style.display = 'block'; 
                return; 
            }
        }
        
        if(source) {
            try { source.stop(); } catch(e){}
        }

        const rpmSpeed = RPM_BASE_SPEED[rpmMode];
        let initialRate = (rpmSpeed / NORMAL_RPM_VELOCITY) * currentPitchFactor; 
        if (rpmMode === 'off' || NORMAL_RPM_VELOCITY === 0) initialRate = 1.0 * currentPitchFactor;
        initialRate = Math.max(0.01, Math.min(MAX_PLAYBACK_RATE, initialRate)); 

        source = audioCtx.createBufferSource(); 
        source.buffer = buffer; 
        source.loop = true; 
        
        source.playbackRate.value = initialRate; 
        source.connect(audioCtx.destination); 
        
        source.start(0, audioCuePointSeconds); 
        isPlaying = true;
    }

    /**
     * Arrête l'audio et sauvegarde le point de cue actuel.
     */
    function stopAudio() {
        if(source && audioCtx && buffer) {
            try { 
                audioCuePointSeconds = rotationToAudioOffset(currentRotation, buffer.duration);
                source.stop(); 
            } catch(e){
                console.error("Erreur lors de l'arrêt de la source audio:", e);
            }
        }
        source = null;
        isPlaying = false;
    }

    // --- Moteur Physique ---
    function updateCenter(){ 
        const r = vinyl.getBoundingClientRect(); 
        center.x = r.left + r.width/2; 
        center.y = r.top + r.height/2; 
    }
    updateCenter(); 
    window.addEventListener("resize", updateCenter);

    /**
     * Calcule l'angle du pointeur par rapport au centre de la platine.
     * L'angle est entre -180 et 180 degrés. 0° = droite, 90° = haut.
     */
    function getAngle(e){ 
        return Math.atan2(e.clientY - center.y, e.clientX - center.x) * 180 / Math.PI; 
    }

    vinyl.addEventListener("pointerdown", async e => { 
        const angle = getAngle(e);
        
        // Zone de Scratch Côté Gauche (90° à 180° ET -180° à -90°)
        const isInScratchZone = (angle >= 90) || (angle <= -90);

        if (isInScratchZone) {
            // Mode Scratch activé
            if(!isPlaying && rpmMode !== 'off') {
                 await startPlayback(); 
            }
            
            isDragging = true; 
            lastAngle = angle; 
            vinyl.setPointerCapture(e.pointerId); 
            vinyl.style.cursor = "grabbing";
        } else {
            // Clic en dehors de la zone de scratch. Le mouvement de la souris n'aura pas d'effet.
            isDragging = false; 
            vinyl.setPointerCapture(e.pointerId); 
            vinyl.style.cursor = "grab";
        }
    });

    vinyl.addEventListener("pointermove", e => { 
        // Le mouvement n'est traité que si isDragging est VRAI (défini dans pointerdown)
        if(!isDragging) return; 
        if(!isPlaying) return; 

        const ang = getAngle(e); 
        let delta = ang - lastAngle; 
        if(delta > 180) delta -= 360; 
        if(delta < -180) delta += 360; 
        lastAngle = ang; 
        
        const dragDelta = delta * dragSensitivity; 
        
        // Calculer la différence de vitesse demandée
        const requestedChange = dragDelta - velocity;

        // APPLIQUER LA LIMITE D'ACCÉLÉRATION (Slew Rate Limiter)
        // Correction de la syntaxe de Math.max et de la variable R_ACCELERATION (non définie)
        const limitedChange = Math.max(
            -MAX_SCRATCH_ACCELERATION, 
            Math.min(MAX_SCRATCH_ACCELERATION, requestedChange)
        );

        velocity += limitedChange; 
        currentRotation += velocity; 
        targetBaseVelocity = velocity; 
    });

    vinyl.addEventListener("pointerup", () => { 
        isDragging = false; 
        // Revenir à la vitesse RPM cible, modulée par le pitch
        updateTargetVelocity(); 
        vinyl.style.cursor = "grab";
        
        if(rpmMode === 'off') {
            stopAudio(); 
            currentRotation = 0;
            vinyl.style.transform = `translate(-50%, -50%) rotate(0deg)`;
        }
    });
    
    // --- Calcul de la vitesse cible ---
    function updateTargetVelocity() {
        if (!isDragging) {
            targetBaseVelocity = RPM_BASE_SPEED[rpmMode] * currentPitchFactor;
        }
    }

    function engine(){ 
        if(!isDragging){ 
            // Transition progressive (accélération/décélération) vers la vitesse cible
            velocity += (targetBaseVelocity - velocity) * returnStrength; 
        } 
        
        currentRotation += velocity; 
        vinyl.style.transform = `translate(-50%, -50%) rotate(${currentRotation}deg)`; 
        
        // Mise à jour de la vitesse de lecture audio (Pitch Shift)
        if(source && audioCtx && isPlaying){ 
            
            let targetRate = (velocity / NORMAL_RPM_VELOCITY) * currentPitchFactor; 
            
            // LIMITER LA VITESSE MAXIMALE DU SON
            const finalRate = Math.max(0.01, Math.min(MAX_PLAYBACK_RATE, targetRate)); 
            
            source.playbackRate.value = finalRate; 
        } 
        
        requestAnimationFrame(engine); 
    }
    engine();

    // --- Logique de Contrôle RPM ---
    function setRPM(mode){
        rpmMode = mode;
        updateTargetVelocity(); 

        if (mode !== 'off') {
            const isStartingNew = !isPlaying;

            // Démarrage de la vitesse légèrement plus haute que la cible (spin up)
            velocity = targetBaseVelocity * 1.2; 
            
            if (isStartingNew) {
                startPlayback(); 
            } 

        } else {
            // Mode Arrêt
            velocity = 0; 
            stopAudio(); 
        }

        // Mettre à jour l'interface utilisateur
        rpmChoices.forEach(c => c.classList.remove('active'));
        document.querySelector(`.rpm-choice[data-rpm='${mode}']`).classList.add('active');
        
        // Rotation du bouton (45 - OFF - 33)
        if(mode === "45") rpmImg.style.transform = "rotate(-30deg)"; 
        else if(mode === "33") rpmImg.style.transform = "rotate(30deg)"; 
        else rpmImg.style.transform = "rotate(0deg)";
    }

    rpmChoices.forEach(c => c.addEventListener('click', () => { setRPM(c.dataset.rpm); }));

    // --- Logique du Slider Pitch ---
    pitchSlider.addEventListener('input', () => {
        const percentageChange = parseFloat(pitchSlider.value) / 100; 
        currentPitchFactor = 1.0 + percentageChange;
        
        updateTargetVelocity(); 
    });


    // --- Logique du Bouton Arrêt ---
    stopBtn.addEventListener('click', () => {
        setRPM("off"); 
    });

    // --- Logique du Bouton Zoom ---
    zoomBtn.addEventListener('click', () => {
        isZoomed = !isZoomed;
        if(isZoomed) {
            turntableContainer.style.transform = "scale(1.5)";
            zoomBtn.classList.add("zoom-active");
        } else {
            turntableContainer.style.transform = "scale(1)";
            zoomBtn.classList.remove("zoom-active");
        }
        setTimeout(updateCenter, 550);
    });
    
    // Initialisation
    setRPM("off");

</script>
</body>
</html>
