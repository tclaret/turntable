<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Turntable (Fixed)</title>
<link rel="icon" href="data:,">

<style>
/* ------------------------------------
       FULL CSS STYLES RESTORED
------------------------------------ */
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
        height: 100vh;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        background:#333; /* Background restored */
        user-select:none;
        color:white;
        font-family:Arial;
    }

    h1 {
        position:absolute;
        top:5%;
        text-align:center;
        width:100%;
    }

    #turntable-container {
        position:relative;
        width:80vw; height:80vw;
        max-width:700px; max-height:700px;
        aspect-ratio:1/1;
        background:#a08c78; /* Turntable base color restored */
        border-radius:10px;
        display:flex;
        justify-content:center;
        align-items:center;
        overflow:hidden;
        transition:transform .3s ease;
    }

    .zoomed-view { transform:scale(1.3); }

    #vinyl {
        position:absolute;
        inset:5%;
        width:90%;
        height:90%;
        aspect-ratio:1/1;
        border-radius:50%;
        object-fit:contain;
        cursor:grab;
        transform:rotate(0deg) translateZ(0);
        will-change:transform;
    }

    #controls-wrapper {
        position:absolute;
        width:100%; height:100%;
        pointer-events:none;
    }

    button {
        pointer-events:auto;
        padding:10px 20px;
        border:none;
        border-radius:6px;
        font-weight:bold;
        color:white;
        cursor:pointer;
    }

    #stop-button { background:#c0392b; position:absolute; top:20px; left:20px; }
    #zoom-button { background:#3498db; position:absolute; top:20px; left:120px; }

    #speed-control, #pitch-control {
        position:absolute;
        bottom:30px;
        font-size:14px;
        pointer-events:auto;
        display:flex;
        align-items:center;
    }

    #speed-control { left:20px; }
    #pitch-control { right:20px; }

    .knob-container {
        display:flex;
        background:#222;
        padding:5px;
        margin-left:10px;
        border-radius:10px;
    }
    .knob-container input { display:none; }
    .knob-container label {
        background:#555;
        padding:5px 10px;
        margin:0 2px;
        border-radius:5px;
        cursor:pointer;
    }
    .knob-container input:checked + label {
        background:#1abc9c;
        font-weight:bold;
    }

    input[type="range"] {
        -webkit-appearance:none;
        width:150px;
        height:10px;
        background:#ccc;
        border-radius:5px;
        margin-left:10px;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance:none;
        width:12px; height:22px;
        background:#2c3e50;
        border-radius:3px;
        cursor:pointer;
    }
</style>
</head>

<body>

<h1 id="status">Loading audio (Preload=auto)...</h1>

<div id="turntable-container">
    <img id="vinyl" src="img/DISC.png" alt="Vinyl Record">

    <div id="controls-wrapper">
        <button id="stop-button">STOP</button>
        <button id="zoom-button">ZOOM</button>

        <div id="speed-control">
            SPEED:
            <div class="knob-container">
                <input type="radio" id="speed-45" name="rpm" value="45">
                <label for="speed-45">45</label>

                <input type="radio" id="speed-off" name="rpm" value="off" checked>
                <label for="speed-off">OFF</label>

                <input type="radio" id="speed-33" name="rpm" value="33">
                <label for="speed-33">33</label>
            </div>
        </div>

        <div id="pitch-control">
            PITCH:
            <input type="range" id="pitch-slider" min="-10" max="10" value="0">
            <span id="pitch-value">0%</span>
        </div>
    </div>
</div>

<script>
/* ------------------------------------
       VARIABLES
------------------------------------ */
const vinyl = document.getElementById("vinyl");
const statusTxt = document.getElementById("status");
const turntable = document.getElementById("turntable-container");
const pitchSlider = document.getElementById("pitch-slider");
const pitchValue = document.getElementById("pitch-value");
const audioPath = "James_Brown_The_Famous_Flames_-_Ain_t_That_A_Groove_Part_1_2_.mp3";

let audioContext = null;
let audioBuffer = null;
let audioSource = null;
let audioReady = false;

let center = {x:0, y:0};
let isDragging = false;
let lastAngle = 0;
let currentRotation = 0;
let velocity = 0;
let targetVelocity = 0;
let smoothing = 0.08;

/* audio params */
const SCRATCH_SENS = 0.04;
const BASE_RATE_33 = 0.9;
const BASE_RATE_45 = 1.2;
let baseRate = BASE_RATE_33;
let pitchOffset = 0;

/* ------------------------------------
       ENGINE LOOP (SYNC CORE)
------------------------------------ */
function engineLoop() {
    // 1. Smoothen the rotation velocity towards the target (RPM or Scratch velocity)
    velocity += (targetVelocity - velocity) * smoothing;
    currentRotation += velocity;
    
    // 2. Apply visual rotation
    vinyl.style.transform = `rotate(${currentRotation}deg) translateZ(0)`;

    // 3. Apply rotation/scratch to the audio playback rate for synchronization
    if (audioSource && audioContext && audioContext.state === 'running') {
        // Calculate the final playback rate based on:
        // Base RPM + Drag/Scratch Velocity (scaled) + Pitch Offset
        const rate = Math.max(0.05, baseRate + velocity * SCRATCH_SENS + pitchOffset);
        audioSource.playbackRate.setValueAtTime(rate, audioContext.currentTime);
    }

    requestAnimationFrame(engineLoop);
}
requestAnimationFrame(engineLoop);

/* ------------------------------------
       RPM CONTROL
------------------------------------ */
function setRPM(mode) {
    if (mode === "33") {
        baseRate = BASE_RATE_33;
        targetVelocity = 360 / 1.8 / 60; // Calculate rotation speed for 33rpm
        if (audioReady && audioContext && audioContext.state === 'running') {
            startAudio(baseRate);
        }
    }
    else if (mode === "45") {
        baseRate = BASE_RATE_45;
        targetVelocity = 360 / 1.3 / 60; // Calculate rotation speed for 45rpm
        if (audioReady && audioContext && audioContext.state === 'running') {
            startAudio(baseRate);
        }
    }
    else {
        targetVelocity = 0;
        stopAudio();
    }
}

document.querySelectorAll('input[name="rpm"]').forEach(btn => {
    btn.addEventListener("change", () => {
        // Attempt to resume context on interaction
        if (audioContext && audioContext.state !== 'running') {
            audioContext.resume().then(() => {
                statusTxt.textContent = "Audio Enabled. Pick an RPM to start.";
                setRPM(btn.value);
            });
        } else {
            setRPM(btn.value);
        }
    });
});

/* ------------------------------------
       DRAG (SCRATCH LOGIC)
------------------------------------ */
function updateCenter() {
    const r = turntable.getBoundingClientRect();
    center.x = r.left + r.width/2;
    center.y = r.top + r.height/2;
}

function angleAt(e){
    return Math.atan2(e.clientY - center.y, e.clientX - center.x) * 180 / Math.PI;
}

vinyl.addEventListener("pointerdown", e => {
    // Attempt to resume context on drag start (first interaction)
    if (audioContext && audioContext.state !== 'running') {
        audioContext.resume().then(() => {
            statusTxt.textContent = "Audio Enabled. Pick an RPM to start.";
        });
    }

    if (document.querySelector('input[name="rpm"]:checked').value === "off")
        return;

    isDragging = true;
    updateCenter();
    lastAngle = angleAt(e);
    vinyl.setPointerCapture(e.pointerId);
});

vinyl.addEventListener("pointermove", e => {
    if (!isDragging) return;

    const a = angleAt(e);
    let delta = a - lastAngle;
    
    if (delta > 180) delta -= 360;
    if (delta < -180) delta += 360;
    
    lastAngle = a;
    currentRotation += delta;
    vinyl.style.transform = `rotate(${currentRotation}deg) translateZ(0)`;

    // Set the instantaneous velocity to the rotation delta for scratch sync
    velocity = delta;
    targetVelocity = delta;
});

vinyl.addEventListener("pointerup", () => {
    isDragging = false;
    // When drag ends, return to the selected RPM speed
    const mode = document.querySelector('input[name="rpm"]:checked').value;
    setRPM(mode);
});

/* ------------------------------------
       PITCH
------------------------------------ */
pitchSlider.addEventListener("input", () => {
    // Pitch adjustment is incorporated into the rate calculation in engineLoop
    pitchOffset = parseInt(pitchSlider.value) / 100;
    pitchValue.textContent = pitchSlider.value + "%";
});

/* ------------------------------------
       AUDIO LOAD + PLAYBACK
------------------------------------ */
function initAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

async function loadAudio(url){
    try {
        initAudioContext();
        statusTxt.textContent = "Loading audio (Preload=auto)...";

        const res = await fetch(url);
        
        if (!res.ok) {
            throw new Error(`Failed to load audio: ${res.status} ${res.statusText}`);
        }
        
        const data = await res.arrayBuffer();
        audioBuffer = await audioContext.decodeAudioData(data);
        audioReady = true;

        statusTxt.textContent = "✓ Audio is preloaded! Tap anywhere or use RPM controls to enable playback.";
        statusTxt.style.color = "#1abc9c";
        
    } catch (error) {
        console.error("Audio loading error:", error);
        statusTxt.textContent = `⚠ Error: ${error.message}. Check audio file path!`;
        statusTxt.style.color = "#ff6b6b";
    }
}

function startAudio(rate){
    if (!audioContext || !audioBuffer || audioContext.state !== 'running') return;
    
    if (audioSource) {
        audioSource.stop();
        audioSource.disconnect();
    }

    audioSource = audioContext.createBufferSource();
    audioSource.buffer = audioBuffer;
    audioSource.loop = true;
    audioSource.connect(audioContext.destination);
    // Initial rate set here, then continuously updated by engineLoop
    audioSource.playbackRate.value = rate; 
    audioSource.start();
}

function stopAudio() {
    if (audioSource) {
        audioSource.stop();
        audioSource.disconnect();
        audioSource = null;
    }
}

/* ------------------------------------
       BUTTONS
------------------------------------ */
document.getElementById("stop-button").onclick = () => {
    document.getElementById("speed-off").checked = true;
    setRPM("off");
    stopAudio();
    statusTxt.textContent = "Audio STOPPED. Pick an RPM to restart.";
};

document.getElementById("zoom-button").onclick = () => {
    turntable.classList.toggle("zoomed-view");
    setTimeout(updateCenter, 300);
};


function enableAudioContext() {
    initAudioContext();
    if (audioContext.state !== 'running') {
        audioContext.resume().then(() => {
            statusTxt.textContent = "Audio Enabled. Pick an RPM to start.";
            document.body.removeEventListener("pointerdown", enableAudioContext);
        });
    }
}

document.body.addEventListener("pointerdown", enableAudioContext, { once: true });


/* ------------------------------------
       INIT
------------------------------------ */
window.addEventListener("resize", updateCenter);
updateCenter();

// Start loading the audio immediately (preload=auto)
loadAudio(audioPath); 
</script>
</body>
</html>
