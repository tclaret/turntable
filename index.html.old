<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Turntable with RPM Selector and Sound</title>
    <link rel="icon" href="data:,">
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #333;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        h1 {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 30px;
            transition: all 0.5s;
        }

        /* Turntable Base (Responsive Width) */
        #turntable-base {
            position: relative;
            width: 80vw; /* 80% of viewport width */
            height: 80vw;
            max-width: 700px; /* Optional: cap maximum size */
            max-height: 700px;
            background-color: #a08c78;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* RPM Selector Placement */
        #control-area {
            position: absolute;
            bottom: 50px;
            left: 50px;
            text-align: center;
            color: #222;
        }

        #speed-selector {
            padding: 5px;
            font-size: 16px;
            margin-top: 5px;
            background-color: #222;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Vinyl Image (Responsive Width) */
        img {
            display: block;
            width: 75vw; /* Slightly smaller than base */
            height: 75vw;
            max-width: 600px; /* Optional: cap maximum size */
            max-height: 600px;
            border-radius: 50%;
            cursor: grab;
            transform: rotate(0deg); 
            transition: 0.05s linear;
        }
        
        /* --- CSS Rotation Animations --- */
        @keyframes spin-33 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes spin-45 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spin-33 {
            animation: spin-33 1.8s linear infinite; /* Slower spin */
        }

        .spin-45 {
            animation: spin-45 1.3s linear infinite; /* Faster spin */
        }
    </style>
</head>

<body>
    <h1>Loading Audio... Please click the screen to resume audio on mobile.</h1>
    
    <div id="turntable-base">
        <div id="control-area">
            <label for="speed-selector">Speed</label>
            <select id="speed-selector">
                <option value="off">OFF</option>
                <option value="33" selected>33</option>
                <option value="45">45</option>
            </select>
        </div>
        
        <img id="vinyl" src="img/DISC.png" alt="Disque">
    </div>

    <script>
        const vinyl = document.getElementById("vinyl");
        const napis = document.querySelector("h1");
        const selector = document.getElementById("speed-selector");

        let isDragging = false;
        let startAngle = 0;
        let currentRotation = 0;
        let lastRotation = 0;
        let center = { x: 0, y: 0 };
        let rotationSpeed = 0;
        let decelerationInterval; 

        // --- AUDIO VARIABLES & CONSTANTS ---
        let audioContext;
        let audioBuffer;
        let audioSource;

        // Tune these values for sensitivity and default speed
        const SCRATCH_SENSITIVITY = 0.05; // How much drag speed affects pitch
        const BASE_RATE_33 = 0.9; // Playback rate for 33 RPM
        const BASE_RATE_45 = 1.2; // Playback rate for 45 RPM
        let currentBaseRate = BASE_RATE_33; 

        // --- Utility Functions ---
        function getAngle(x, y) {
            return Math.atan2(y - center.y, x - center.x) * (180 / Math.PI);
        }
        
        function updateCenter() {
            const base = document.getElementById('turntable-base');
            const rect = base.getBoundingClientRect();
            center.x = rect.left + rect.width / 2;
            center.y = rect.top + rect.height / 2;
        }

        function applyRotation(angle) {
            vinyl.style.transform = `rotate(${angle}deg)`;
            currentRotation = angle;
        }
        
        // --- AUDIO FUNCTIONS ---

        async function loadAudio(url) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            napis.textContent = "Fetching sound file...";

            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                napis.textContent = "Audio ready. Spinning up...";
                // Start the audio source but set its rate to the current RPM rate
                startAudioSource(currentBaseRate); 
            } catch (error) {
                console.error('Error loading audio:', error);
                napis.textContent = "Error loading sound file. Check console.";
            }
        }
        
        function startAudioSource(rate) {
            if (audioSource) {
                audioSource.stop();
            }

            audioSource = audioContext.createBufferSource();
            audioSource.buffer = audioBuffer;
            audioSource.loop = true; 
            audioSource.connect(audioContext.destination);
            audioSource.playbackRate.value = rate;

            audioSource.start(0); 
        }

        function updateAudioRate(rate) {
            if (audioSource) {
                // Smooth transition for rate change (0.01 seconds)
                audioSource.playbackRate.setTargetAtTime(rate, audioContext.currentTime, 0.01); 
            }
        }

        // --- RPM Management Functions ---
        
        function stopAllRotation() {
            // 1. Stop CSS Animation
            vinyl.classList.remove('spin-33', 'spin-45');
            // 2. Clear any scratch deceleration
            if (decelerationInterval) {
                clearInterval(decelerationInterval);
                rotationSpeed = 0;
            }
            vinyl.style.transform = ''; 

            // 3. Stop sound
            if (audioSource) {
                updateAudioRate(0); // Playback rate of 0 stops the sound
            }
        }

        function startAutomaticRotation(rpm) {
            stopAllRotation(); 
            currentBaseRate = (rpm === "33") ? BASE_RATE_33 : BASE_RATE_45;

            if (rpm === "off") {
                napis.textContent = "DJ Scratch Turntable (OFF)";
                return;
            }

            // Vinyl rotation (CSS)
            vinyl.classList.add(`spin-${rpm}`);
            napis.textContent = `Spinning at ${rpm} RPM. Drag to Scratch!`;
            
            // Audio playback
            if (audioBuffer) {
                updateAudioRate(currentBaseRate);
            }
        }
        
        // --- Drag/Scratch Event Handlers ---
        
        function startTurn(e) {
            if (selector.value === "off") return;
            
            e.preventDefault();
            
            // For mobile compatibility, ensure context is not suspended
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            vinyl.classList.remove('spin-33', 'spin-45');
            if (decelerationInterval) clearInterval(decelerationInterval); 

            // Logic to get current rotation angle from CSS transform (for seamless transition)
            const style = window.getComputedStyle(vinyl);
            const transformMatrix = style.getPropertyValue('transform');
            let rotationDeg = 0;
            if (transformMatrix && transformMatrix !== 'none') {
                const values = transformMatrix.split('(')[1].split(')')[0].split(',');
                const a = values[0];
                const b = values[1];
                rotationDeg = Math.round(Math.atan2(b, a) * (180/Math.PI));
            } 
            currentRotation = rotationDeg;
            
            isDragging = true;
            updateCenter();

            const eventX = e.clientX || e.touches[0].clientX;
            const eventY = e.clientY || e.touches[0].clientY;
            
            const pointAngle = getAngle(eventX, eventY);
            
            startAngle = currentRotation - pointAngle;
            lastRotation = currentRotation; 

            window.addEventListener('mousemove', rotate);
            window.addEventListener('mouseup', endTurn);
            window.addEventListener('touchmove', rotate);
            window.addEventListener('touchend', endTurn);
            
            napis.textContent = "Scratching...";
        }

        function rotate(e) {
            if (!isDragging) return;

            const eventX = e.clientX || e.touches[0].clientX;
            const eventY = e.clientY || e.touches[0].clientY;
            
            const newAngle = getAngle(eventX, eventY);
            let newRotation = startAngle + newAngle;

            rotationSpeed = newRotation - lastRotation;
            lastRotation = newRotation; 
            
            applyRotation(newRotation);

            // Update audio playback rate dynamically for scratch sound
            if (audioSource) {
                const scratchRate = currentBaseRate + (rotationSpeed * SCRATCH_SENSITIVITY);
                // Ensure rate doesn't go too low or too high (clamping)
                updateAudioRate(Math.max(0.1, Math.min(3.0, scratchRate))); 
            }
        }

        function endTurn() {
            if (!isDragging) return;

            isDragging = false;
            
            window.removeEventListener('mousemove', rotate);
            window.removeEventListener('mouseup', endTurn);
            window.removeEventListener('touchmove', rotate);
            window.removeEventListener('touchend', endTurn);
            
            if (Math.abs(rotationSpeed) > 0.1) { 
                startDeceleration();
            } else {
                startAutomaticRotation(selector.value);
            }
        }

        function startDeceleration() {
            const decelerationRate = 0.995; 
            vinyl.style.transition = '0s';

            decelerationInterval = setInterval(() => {
                currentRotation += rotationSpeed; 
                applyRotation(currentRotation);

                rotationSpeed *= decelerationRate; 

                // Update audio rate during deceleration
                if (audioSource) {
                    const scratchRate = currentBaseRate + (rotationSpeed * SCRATCH_SENSITIVITY);
                    updateAudioRate(Math.max(0.1, Math.min(3.0, scratchRate)));
                }

                if (Math.abs(rotationSpeed) < 0.01) { 
                    clearInterval(decelerationInterval);
                    // After coasting stops, resume normal RPM
                    startAutomaticRotation(selector.value); 
                }
            }, 5); 
        }
        
        // --- Initial Event Listeners ---
        
        selector.addEventListener('change', () => {
            startAutomaticRotation(selector.value);
        });

        vinyl.addEventListener('mousedown', startTurn);
        vinyl.addEventListener('touchstart', startTurn);
        
        // Double-click/tap to resume/start selected RPM
        const stopResumeHandler = (e) => {
            e.preventDefault();
            stopAllRotation();
            startAutomaticRotation(selector.value); 
        };
        
        vinyl.addEventListener('dblclick', stopResumeHandler);
        vinyl.addEventListener('touchend', (e) => {
            const now = new Date().getTime();
            const lastTouchTime = vinyl.lastTouchTime || 0;
            const delta = now - lastTouchTime;
            const doubleTapThreshold = 300; 

            if (delta > 0 && delta < doubleTapThreshold) {
                stopResumeHandler(e);
            }
            vinyl.lastTouchTime = now;
        });

        // Initial setup and load audio
        window.addEventListener('resize', updateCenter);
        window.addEventListener('load', () => {
            updateCenter();
            // Load audio from the provided GitHub link's resource
            loadAudio('vinyl.mp3'); 
        });
    </script>
</body>

</html>
